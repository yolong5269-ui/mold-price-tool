<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>模具材料計算系統 v1.3</title>
<style>
  :root{
    --bg:#f5f5f7; --card:#fff; --text:#111; --muted:#666;
    --line:#e5e5e5; --field:#fff; --fieldLine:#cfcfcf;
    --radius:14px; --gap:14px; --h:42px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
  }
  .wrap{max-width:1180px;margin:0 auto;padding:18px}
  .card{
    background:var(--card); border:1px solid var(--line);
    border-radius:var(--radius); box-shadow:0 10px 30px rgba(0,0,0,.06);
    padding:18px;
  }
  h1{margin:0 0 8px;font-size:20px}
  .sub{color:var(--muted);font-size:12px;line-height:1.55;margin-bottom:14px}
  .pill{
    display:inline-block;background:#f0f0f0;border-radius:999px;
    padding:4px 10px;font-size:12px;color:#555;margin-right:8px;margin-top:8px
  }

  .section{border-top:1px solid var(--line);padding-top:16px;margin-top:16px}
  .section:first-of-type{border-top:none;padding-top:0;margin-top:0}
  .section-title{font-size:15px;font-weight:800;margin:0 0 10px}

  .grid{
    display:grid;
    grid-template-columns:repeat(12, minmax(0, 1fr));
    gap:var(--gap);
    align-items:stretch;
  }
  .col-12{grid-column:span 12}
  .col-6{grid-column:span 6}
  .col-4{grid-column:span 4}
  .col-3{grid-column:span 3}
  .col-2{grid-column:span 2}
  @media (max-width: 760px){
    .wrap{padding:12px}
    .grid{grid-template-columns:repeat(1, minmax(0, 1fr))}
    .col-12,.col-6,.col-4,.col-3,.col-2{grid-column:span 1}
  }

  .field{
    display:flex;flex-direction:column;gap:6px;
    min-width:0;
    padding:10px 10px 12px;
    border:1px solid var(--line);
    border-radius:12px;
    background:#fff;
    min-height:104px;
  }
  .label{
    font-size:12px;color:#444;font-weight:700;
    display:flex;align-items:center;gap:8px;line-height:1.2;
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  }
  .info{
    display:inline-flex;align-items:center;justify-content:center;
    width:18px;height:18px;border-radius:999px;
    background:#f0f0f0;color:#444;font-size:12px;font-weight:800;
    cursor:help;flex:0 0 auto;
  }
  input,select{
    width:100%;height:var(--h);
    padding:10px 12px;border:1px solid var(--fieldLine);border-radius:10px;
    background:var(--field);font-size:14px;outline:none;
  }
  input:focus,select:focus{border-color:#007aff;box-shadow:0 0 0 3px rgba(0,122,255,.12)}
  input[disabled]{background:#f2f2f2;color:#666}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width: 760px){ .row2{grid-template-columns:1fr} }

  .note{
    margin-top:10px;
    padding:10px 12px;
    border:1px dashed #d8d8d8;
    background:#fafafa;
    border-radius:12px;
    color:#555;
    font-size:12px;
    line-height:1.55;
  }

  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
  button{height:40px;padding:0 14px;border:none;border-radius:10px;font-size:14px;cursor:pointer}
  .btn-primary{background:#007aff;color:#fff}
  .btn-ghost{background:#eee;color:#222}

  .warn,.ok{
    margin-top:12px;padding:10px;border-radius:10px;line-height:1.55;font-size:13px;display:none
  }
  .warn{border:1px solid #f0c36d;background:#fff7e6;color:#6a4b00}
  .ok{border:1px solid #b7e1c1;background:#f2fff6;color:#1f6a3a}

  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border:1px solid #ddd;padding:8px;text-align:center}
  th{background:#f0f0f0}
  .totalRow td{background:#fafafa;font-weight:800}

  /* ✅ 修正：手機 BOM 不裁切（可左右滑） */
  .tableWrap{
    width:100%;
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    border-radius:12px;
  }
  .tableWrap table{ min-width:720px; }

  /* ===== Schematic + Auto Scale ===== */
  #schematic{
    margin-top:10px;border:1px solid var(--line);border-radius:12px;
    padding:14px;background:#fff;
  }
  .schemViewport{ overflow:auto; border-radius:12px; padding:4px; }
  .schemCanvas{ display:inline-block; transform-origin: top left; will-change: transform; }

  .schemWrap{
    display:grid;
    grid-template-columns:180px 1fr 180px;
    gap:14px;
    min-width:860px;
  }
  .schemLegend{
    border:1px solid var(--line);border-radius:12px;padding:12px;background:#fafafa;
    font-size:12px;color:#555;line-height:1.55;
  }
  .schemLegend .k{display:flex;align-items:center;gap:8px;margin:6px 0}
  .swatch{width:14px;height:14px;border-radius:4px;border:1px solid #bbb}
  .schemLeft{font-size:12px;color:#555;line-height:1.6;padding:6px 0}
  .schemLeft .line{margin:8px 0}
  .stackFrame{border:1px solid #e0e0e0;border-radius:14px;padding:12px;background:#fff}

  .barRow{display:flex;justify-content:center}
  .bar{
    border:1px solid #cfcfcf;border-radius:12px;
    padding:8px 10px;margin:6px 0;
    display:flex;flex-direction:column;gap:4px;
    overflow:hidden;
    position:relative;
    min-height:96px;
    padding-top:12px;
    padding-bottom:12px;
  }
  .barTitle{
    font-size:13px;font-weight:800;color:#222;
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    padding-right:140px;
  }
  .barSub{font-size:12px;color:#666;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  /* 分模面：一條線 */
  .partingLine{
    height:14px; display:flex; align-items:center; justify-content:center;
    margin:4px 0 10px;
  }
  .partingLine::before{
    content:"";
    height:2px; width:92%;
    background:rgba(0,0,0,.28);
    border-radius:999px;
  }

  /* ✅ 層間並排：不顯示外框/標題，只保留內容本體 */
  .inlineZone{
    width:100%;
    border:none;
    border-radius:0;
    padding:0;
    margin:6px 0;
    background:transparent;
  }
  .zoneInner{
    display:grid;
    gap:0;
    align-items:stretch;
    border-radius:12px;
    overflow:hidden;
    border:1px solid rgba(0,0,0,.08);
    background:#fff;
  }
  .leg{
    background:#d6d6d6;border-right:1px solid #bdbdbd;
    min-height:70px;
    display:flex;align-items:center;justify-content:center;
    font-size:12px;color:#333;
  }
  .leg.right{border-right:none;border-left:1px solid #bdbdbd}
  .window{
    padding:10px;
    display:flex;flex-direction:column;gap:10px;
    min-height:70px;
  }
  .chip{
    border-radius:10px;padding:10px 12px;font-size:12px;font-weight:700;
    border:1px solid transparent;
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  }
  .chipHot{background:#ffe3d6;border-color:#d59a84;color:#5a2b1a}
  .chipEj{background:#dff3ff;border-color:#8bb6d6;color:#123a55}

  /* ✅ Insert：右上角標籤（不疊字） */
  .insertBadge{
    position:absolute;
    right:12px;
    top:10px;
    padding:4px 10px;
    border-radius:999px;
    background:rgba(255,255,255,.9);
    border:1px solid rgba(0,0,0,.08);
    font-size:12px;
    font-weight:700;
    color:#333;
    max-width:70%;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    pointer-events:none;
  }

  /* ===== Insert 區域：陰影（嵌入感） ===== */
  .insertBox{
    position:absolute;
    left:10%;
    top:52px;
    width:80%;
    height:calc(100% - 64px);
    border-radius:14px;
    pointer-events:none;
    box-shadow:
      inset 0 2px 4px rgba(0,0,0,.10),
      inset 0 -2px 3px rgba(255,255,255,.55);
  }
  .insertBoxA{
    background:linear-gradient(to bottom, rgba(255,246,240,.72), rgba(255,246,240,.38));
  }
  .insertBoxB{
    background:linear-gradient(to bottom, rgba(242,250,255,.70), rgba(242,250,255,.36));
  }
</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>模具材料計算系統 v1.3</h1>
    <div class="sub">
      ✅ 模腳高度：<b>B 模腳高度 = EjectStroke + Preload</b>，且 Auto-Hp：EjectStroke = 2×Hp + 3。<br>
      ✅ A 側（Hot）母模腳厚度：<b>固定 70mm</b>（熱澆道空間）。<br>
      ✅ Preload 不綁模具等級（級距/手動互斥）。<br>
      ✅ 材料採購：Insert 模式採購以整塊模板 + 模仁材料（不扣口袋挖除）。<br>
      ✅ 寬度邏輯：<b>頂針板寬 = Wins（Solid 也用等效 Wins）</b>；Hot 模式 A 側：<b>W_need = max(Wins, W_hot_min)</b> → 反推模腳寬（左右對稱、貼齊模板兩側）。<br>
      ✅ A/B 成型板 BOM 採購厚度：<b>淨厚 + Hp + 加工餘量</b>（示意圖維持淨厚）。<br>
      <div>
        <span class="pill">A=母模（Cavity）｜B=公模（Core）</span>
        <span class="pill">體積：cm³｜重量：kg｜密度 7.85 g/cm³</span>
      </div>
    </div>

    <div class="actions" style="margin-top:0">
      <button class="btn-ghost" type="button" onclick="preset('S')">自測：小模</button>
      <button class="btn-ghost" type="button" onclick="preset('L')">自測：大型外觀件</button>
      <button class="btn-ghost" type="button" onclick="preset('XL')">自測：保險桿</button>
    </div>

    <div class="section">
      <div class="section-title">成品尺寸</div>
      <div class="grid">
        <div class="field col-6">
          <div class="label">Lp 成品投影長（mm）</div>
          <input id="Lp" type="number" min="1" placeholder="例如 1200" oninput="updatePreview();">
        </div>
        <div class="field col-6">
          <div class="label">Wp 成品投影寬（mm）</div>
          <input id="Wp" type="number" min="1" placeholder="例如 500" oninput="updatePreview();">
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-title">模具結構設定</div>
      <div class="grid">
        <div class="field col-4">
          <div class="label">模具等級</div>
          <select id="MoldSizeClass" onchange="updatePreview();">
            <option value="S">S 小模</option>
            <option value="M" selected>M 中模</option>
            <option value="L">L 大型外觀件</option>
            <option value="XL">XL 保險桿 / 超大型</option>
          </select>
        </div>

        <div class="field col-4">
          <div class="label">
            模具結構型式
            <span class="info" title="Insert：模仁埋入成型板內（加工概念）。材料採購以整塊模板 + 模仁材料為準。">i</span>
          </div>
          <select id="MoldConstruction" onchange="updatePreview();">
            <option value="Solid">無模仁（Solid）</option>
            <option value="Insert">有模仁（Insert）</option>
          </select>
        </div>

        <div class="field col-4">
          <div class="label">澆口系統</div>
          <select id="GateType" onchange="syncHotQtyUI(); updatePreview();">
            <option value="Cold" selected>冷流道</option>
            <option value="Hot">熱澆道</option>
          </select>
        </div>
        <!-- ✅ 熱澆道數量（只在 Hot 顯示；數字輸入） -->
        <div class="field col-4" id="HotQtyWrap" style="display:none">
          <div class="label">熱澆道數量（組）</div>
          <input id="HotQty" type="number" min="1" step="1" value="1" inputmode="numeric" pattern="[0-9]*"
                 oninput="sanitizeHotQty(); updatePreview();">
        </div>

        <div class="field col-4">
          <div class="label">側向滑塊</div>
          <select id="HasSlider" onchange="updatePreview();">
            <option value="no" selected>沒有</option>
            <option value="yes">有</option>
          </select>
        </div>
      </div>

      <div class="note">
        有滑塊：模座 L/W 額外 +100mm。<br>
        封頂板寬度外擴：W_clamp = Wm + 2×ΔW（S20/M30/L40/XL50）。<br>
        Hot 模式：W_need = max(Wins, W_hot_min) 用於反推模腳寬。<br>
        Hot 模式 A 側母模腳厚度固定：70mm。
      </div>
    </div>

    <div class="section">
      <div class="section-title">分模設定（Auto / Manual 互斥）</div>
      <div class="grid">
        <div class="field col-4">
          <div class="label">分模模式</div>
          <select id="SplitMode" onchange="syncSplitUI(); updatePreview();">
            <option value="Auto" selected>Auto（輸入 Hp + 母模比例）</option>
            <option value="ManualHeights">Manual（輸入 Hcav/Hcore）</option>
          </select>
        </div>

        <div class="field col-4" id="AutoHpWrap">
          <div class="label">Hp 成品厚度 / 總高度（mm）</div>
          <input id="Hp" type="number" min="1" placeholder="例如 40 或 200" oninput="updatePreview();">
        </div>

        <div class="field col-4" id="AutoRatioWrap">
          <div class="label">母模比例（Auto）</div>
          <input id="ASplitRatio" type="number" step="0.01" min="0.10" max="0.90" value="0.40" oninput="updatePreview();">
        </div>

        <div class="field col-4" id="ManualHcavWrap" style="display:none">
          <div class="label">Hcav 母面實際深度（mm）</div>
          <input id="Hcav" type="number" min="1" placeholder="例如 150" oninput="updatePreview();">
        </div>

        <div class="field col-4" id="ManualHcoreWrap" style="display:none">
          <div class="label">Hcore 公面實際高度（mm）</div>
          <input id="Hcore" type="number" min="1" placeholder="例如 250" oninput="updatePreview();">
        </div>

        <div class="field col-4" id="ManualHpReadWrap" style="display:none">
          <div class="label">Hp（自動加總）</div>
          <input id="HpComputed" type="number" disabled>
        </div>
      </div>

      <div class="note">
        Auto：DA(母)=Hp×比例；DB(公)=Hp-DA。<br>
        Manual：Hp=Hcav(母)+Hcore(公)。
      </div>
    </div>

    <div class="section">
      <div class="section-title">頂出 / 支撐 / 框架寬度（左右模腳對稱，貼齊模板兩側）</div>

      <div class="grid">
        <div class="field col-4">
          <div class="label">
            頂出行程模式（互斥）
            <span class="info" title="Manual：手動輸入。Auto-Hp：EjectStroke=2×Hp+3（主邏輯）。Auto-DB：保留舊模式。">i</span>
          </div>
          <select id="EjectMode" onchange="syncEjectUI(); updatePreview();">
            <option value="AutoHp" selected>Auto-Hp（2×Hp+3）</option>
            <option value="Manual">Manual（手動輸入）</option>
            <option value="AutoDb">Auto-DB（DB×Ratio+Offset）</option>
          </select>
        </div>

        <div class="field col-4" id="EjectManualWrap" style="display:none">
          <div class="label">頂出作動行程 EjectStroke（mm）</div>
          <input id="EjectStroke" type="number" min="0" value="100" oninput="updatePreview();">
        </div>

        <div class="field col-4" id="EjectAutoHpWrap">
          <div class="label">EjectStroke（Auto-Hp 計算，mm）</div>
          <input id="EjectStrokeHp" type="number" disabled>
        </div>

        <div class="field col-2" id="EjectAutoRatioWrap" style="display:none">
          <div class="label">Auto-DB：Ratio（×DB）</div>
          <input id="EjectRatio" type="number" step="0.01" min="0.10" max="1.00" value="0.40" oninput="updatePreview();">
        </div>

        <div class="field col-2" id="EjectAutoOffsetWrap" style="display:none">
          <div class="label">Auto-DB：Offset（mm）</div>
          <input id="EjectOffset" type="number" step="1" min="0" max="200" value="20" oninput="updatePreview();">
        </div>

        <div class="field col-4" id="EjectAutoClampWrap" style="display:none">
          <div class="label">Auto-DB：Min / Max（mm）</div>
          <div class="row2">
            <input id="EjectMin" type="number" min="0" value="60" oninput="updatePreview();">
            <input id="EjectMax" type="number" min="0" value="220" oninput="updatePreview();">
          </div>
        </div>

        <div class="field col-4" id="EjectAutoDbComputedWrap" style="display:none">
          <div class="label">EjectStroke（Auto-DB 計算，mm）</div>
          <input id="EjectStrokeDb" type="number" disabled>
        </div>

        <div class="field col-4">
          <div class="label">
            彈簧預壓模式（互斥）
            <span class="info" title="不跟模具等級綁。級距：選擇常用預壓量；手動：輸入任意值。">i</span>
          </div>
          <select id="PreloadMode" onchange="syncPreloadUI(); updatePreview();">
            <option value="Step" selected>級距選擇</option>
            <option value="Manual">手動輸入</option>
          </select>
        </div>

        <div class="field col-4" id="PreloadStepWrap">
          <div class="label">預壓量 Preload（mm）</div>
          <select id="PreloadStep" onchange="updatePreview();">
            <option value="10">10</option>
            <option value="12">12</option>
            <option value="15" selected>15</option>
            <option value="20">20</option>
            <option value="25">25</option>
          </select>
        </div>

        <div class="field col-4" id="PreloadManualWrap" style="display:none">
          <div class="label">預壓量 Preload（mm）</div>
          <input id="PreloadManual" type="number" min="0" value="15" oninput="updatePreview();">
        </div>

        <div class="field col-4">
          <div class="label">B 模腳高度（mm）= EjectStroke + Preload</div>
          <input id="LegHeightBOut" type="number" disabled>
        </div>

        <div class="field col-4">
          <div class="label">總壓縮量（mm）= EjectStroke + Preload</div>
          <input id="TotalDeflectionOut" type="number" disabled>
        </div>

        <div class="field col-4">
          <div class="label">
            頂針板基準厚度（獨立級距）
            <span class="info" title="此厚度不再綁模具等級。若啟用加厚規則，會在基準厚度上額外 +5/+10。">i</span>
          </div>
          <select id="EjectPlateBaseT" onchange="updatePreview();">
            <option value="20">20</option>
            <option value="25">25</option>
            <option value="30" selected>30</option>
            <option value="35">35</option>
            <option value="40">40</option>
            <option value="45">45</option>
          </select>
        </div>

        <div class="field col-4">
          <div class="label">頂針板加厚規則</div>
          <select id="EjectThickenMode" onchange="updatePreview();">
            <option value="On" selected>啟用（>120 +5；>180 再 +5）</option>
            <option value="Off">關閉</option>
          </select>
        </div>

        <div class="field col-4">
          <div class="label">支撐板模式</div>
          <select id="SupportPlateMode" onchange="updatePreview();">
            <option value="Merged" selected>與公模合併</option>
            <option value="Separate">獨立支撐板（全尺寸）</option>
          </select>
        </div>

        <div class="field col-4">
          <div class="label">下封頂板加厚</div>
          <select id="BottomThicken" onchange="updatePreview();">
            <option value="0" selected>不加厚</option>
            <option value="10">+10 mm</option>
          </select>
        </div>

        <div class="field col-4">
          <div class="label">框架拆寬結果（mm）</div>
          <div class="row2">
            <input id="WLegOut" type="number" disabled placeholder="W_leg（每側）">
            <input id="WWindowOut" type="number" disabled placeholder="W_window（中央可用寬）">
          </div>
        </div>

        <div class="field col-4">
          <div class="label">寬度檢核（必須= Wm）</div>
          <input id="WidthCheck" type="text" disabled placeholder="2*W_leg + W_window = Wm">
        </div>
      </div>

      <div class="actions">
        <!-- ✅ 修正：手機端避免 submit/不觸發 -->
        <button id="calcBtn" class="btn-primary" type="button">計算材料</button>
      </div>

      <div id="warnBox" class="warn"></div>
      <div id="okBox" class="ok"></div>

      <div class="note">
        ✅ 頂針板厚度：獨立級距下拉；不綁模具等級。<br>
        ✅ 頂針板寬（B）固定採：W_eject = Wins（Solid 也用等效 Wins）。<br>
        ✅ Hot（A）視窗需求：W_need = max(Wins, W_hot_min)，先用它反推 W_leg。<br>
        ✅ 示意圖：仍顯示 A/B 淨厚；BOM：A/B 成型板採購厚度會加 Hp + 加工餘量。<br>
        ✅ Hot（A）母模腳高度固定：70mm。
      </div>
    </div>

    <div class="section">
      <div class="section-title">材料 BOM（體積：cm³｜重量：kg）</div>
      <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>項目</th><th>尺寸（mm）</th><th>數量</th><th>體積（cm³）</th><th>重量（kg）</th>
          </tr>
        </thead>
        <tbody id="bom"></tbody>
      </table>
      </div>
      <div class="note">
        Insert 模式：BOM 顯示模板整塊 + 模仁材料（供採購/計價一致）。
      </div>
    </div>

    <div class="section">
      <div class="section-title">模具示意圖（模仁區域可視化｜分模面為一條線）</div>
      <div id="schematic">尚未計算。請輸入參數後按「計算材料」。</div>
    </div>
  </div>
</div>

<script>
  const KG_PER_CM3 = 0.00785; // 7.85 g/cm3
  const C_HOT  = 15;
  const WARN_DEFLECTION = 220;

  // ✅ Hot A-side spacer fixed height
  const HOT_A_SPACER_FIXED = 70; // mm

  const P = {
    edge: { S: 50, M: 80, L: 120, XL: 150 },
    insertMargin: { S:20, M:30, L:40, XL:50 },
    hotMinW: { S:220, M:260, L:320, XL:380 },

    A_back_solid: { S: 80, M: 80, L: 100, XL: 100 },
    B_eject_solid:{ S: 160, M: 180, L: 200, XL: 220 },

    insertBackA: { S: 40, M: 40, L: 50, XL: 60 },
    insertBackB: { S: 40, M: 40, L: 50, XL: 60 },
    A_plate_insert:{ S: 80, M: 80, L: 100, XL: 110 },
    B_plate_insert:{ S: 120, M: 130, L: 150, XL: 170 },

    topClamp:{ S:35, M:40, L:50, XL:60 },
    clampWExtra:{ S:20, M:30, L:40, XL:50 },

    support: { S:30, M:35, L:45, XL:60 },

    hotAllowance:30,

    t_underA:{ S:25, M:30, L:40, XL:50 },
    t_underB:{ S:25, M:30, L:40, XL:50 },

    manifoldH:{ S:30, M:35, L:40, XL:45 },

    legMin:{ S:35, M:45, L:55, XL:65 },

    machAllow:{ S:5, M:8, L:10, XL:12 },
  };

  function $(id){ return document.getElementById(id); }
  function clamp(x, lo, hi){ return Math.max(lo, Math.min(hi, x)); }

  function showWarn(msg){
    const box = $("warnBox");
    if(!msg){ box.style.display="none"; box.innerHTML=""; return; }
    box.style.display="block"; box.innerHTML = msg;
  }
  function showOk(msg){
    const box = $("okBox");
    if(!msg){ box.style.display="none"; box.innerHTML=""; return; }
    box.style.display="block"; box.innerHTML = msg;
  }


  function sanitizeHotQty(){
    const el = $("HotQty");
    if(!el) return;
    let v = String(el.value ?? "");
    v = v.replace(/[^0-9]/g, "");
    if(v === "") v = "1";
    let n = parseInt(v, 10);
    if(!Number.isFinite(n) || n < 1) n = 1;
    el.value = String(n);
  }

  function syncHotQtyUI(){
    const wrap = $("HotQtyWrap");
    if(!wrap) return;
    const isHot = ($("GateType").value === "Hot");
    wrap.style.display = isHot ? "" : "none";
    if(isHot) sanitizeHotQty();
  }

  function syncSplitUI(){
    const mode = $("SplitMode").value;
    if(mode === "Auto"){
      $("AutoHpWrap").style.display = "";
      $("AutoRatioWrap").style.display = "";
      $("ManualHcavWrap").style.display = "none";
      $("ManualHcoreWrap").style.display = "none";
      $("ManualHpReadWrap").style.display = "none";
      $("Hcav").value = ""; $("Hcore").value = ""; $("HpComputed").value = "";
    }else{
      $("AutoHpWrap").style.display = "none";
      $("AutoRatioWrap").style.display = "none";
      $("ManualHcavWrap").style.display = "";
      $("ManualHcoreWrap").style.display = "";
      $("ManualHpReadWrap").style.display = "";
      $("Hp").value = "";
    }
  }

  function syncEjectUI(){
    const mode = $("EjectMode").value;
    $("EjectManualWrap").style.display = (mode==="Manual") ? "" : "none";
    $("EjectAutoHpWrap").style.display  = (mode==="AutoHp") ? "" : "none";

    const isDb = (mode==="AutoDb");
    $("EjectAutoRatioWrap").style.display = isDb ? "" : "none";
    $("EjectAutoOffsetWrap").style.display = isDb ? "" : "none";
    $("EjectAutoClampWrap").style.display = isDb ? "" : "none";
    $("EjectAutoDbComputedWrap").style.display = isDb ? "" : "none";
  }

  function syncPreloadUI(){
    const mode = $("PreloadMode").value;
    $("PreloadStepWrap").style.display = (mode==="Step") ? "" : "none";
    $("PreloadManualWrap").style.display = (mode==="Manual") ? "" : "none";
  }

  function estimateLmWm(){
    const Lp = +$("Lp").value;
    const Wp = +$("Wp").value;
    if(!(Lp > 0 && Wp > 0)) return {Lm:NaN, Wm:NaN};

    const cls = $("MoldSizeClass").value;
    const hasSlider = ($("HasSlider").value === "yes");

    let Lm = Lp + 2 * P.edge[cls];
    let Wm = Wp + 2 * P.edge[cls];
    if(hasSlider){ Lm += 100; Wm += 100; }
    return {Lm, Wm};
  }

  function estimateWClamp(Wm){
    const cls = $("MoldSizeClass").value;
    return Wm + 2*P.clampWExtra[cls];
  }

  function estimateDA_DB_Hp(){
    const splitMode = $("SplitMode").value;
    let DA=NaN, DB=NaN, Hp=NaN;
    if(splitMode === "Auto"){
      Hp = +$("Hp").value;
      let ratio = +$("ASplitRatio").value;
      if(!(ratio > 0 && ratio < 1)) ratio = 0.40;
      if(!(Hp > 0)) return {DA,DB,Hp};
      DA = Hp * ratio;
      DB = Hp - DA;
    }else{
      const Hcav = +$("Hcav").value;
      const Hcore = +$("Hcore").value;
      if(!(Hcav > 0 && Hcore > 0)) return {DA,DB,Hp};
      DA = Hcav; DB = Hcore; Hp = Hcav + Hcore;
      $("HpComputed").value = Hp;
    }
    return {DA,DB,Hp};
  }

  function getPreload(){
    const mode = $("PreloadMode").value;
    if(mode === "Manual") return +$("PreloadManual").value || 0;
    return +$("PreloadStep").value || 0;
  }

  function getEjectStroke(DB, Hp){
    const mode = $("EjectMode").value;
    if(mode === "Manual"){
      return +$("EjectStroke").value || 0;
    }
    if(mode === "AutoHp"){
      if(!(Hp > 0)) return NaN;
      const v = 2*Hp + 3;
      $("EjectStrokeHp").value = Math.round(v);
      return v;
    }
    if(!(DB > 0)) return NaN;
    const ratio = +$("EjectRatio").value;
    const offset = +$("EjectOffset").value;
    const minV = +$("EjectMin").value;
    const maxV = +$("EjectMax").value;
    const raw = DB * ratio + offset;
    const val = clamp(raw, minV, maxV);
    $("EjectStrokeDb").value = Math.round(val);
    return val;
  }

  function rowItem(name, L, W, T, qty){
    const vol_cm3 = (L * W * T * qty) / 1000;
    const wt_kg = vol_cm3 * KG_PER_CM3;
    return { name, size:`${Math.round(L)}×${Math.round(W)}×${Math.round(T)}`, qty, vol_cm3, wt_kg };
  }


  function rowExternal(name, qty){
    // 外購件：只顯示數量，不計體積/重量
    return { name, size:`-`, qty, vol_cm3:0, wt_kg:0 };
  }

  function computeLegWindowFromWins(Wm, Wins, gateType, cls){
    if(!(Wm > 0 && Wins > 0)) return {ok:false, W_leg:0, W_window:0, W_need:0, msg:"Wm/Wins 不足"};

    const W_hot_min = P.hotMinW[cls];
    const W_need = (gateType === "Hot") ? Math.max(Wins, W_hot_min) : Wins;

    let W_leg = Math.floor((Wm - W_need) / 2);
    W_leg = Math.max(W_leg, P.legMin[cls]);

    const W_window = Wm - 2*W_leg;

    let msg = "";
    let ok = true;

    if(W_window <= 0){
      ok = false;
      msg = `寬度不足：Wm=${Math.round(Wm)}，無法形成有效中央視窗（W_window<=0）。`;
    }else if(W_window < W_need){
      ok = true;
      msg = `⚠️ 視窗不足：W_window=${Math.round(W_window)} < W_need=${Math.round(W_need)}（Hot/模仁需求）。請提高等級/加大 Wm。`;
    }
    return {ok, W_leg, W_window, W_need, msg};
  }

  function applySchematicScale(){
    const viewport = document.querySelector(".schemViewport");
    const canvas = document.querySelector(".schemCanvas");
    if(!viewport || !canvas) return;

    canvas.style.transform = "scale(1)";
    const vw = viewport.clientWidth;
    const cw = canvas.getBoundingClientRect().width;
    if(!vw || !cw) return;

    const raw = vw / cw;
    const s = clamp(raw, 0.65, 1.0);
    canvas.style.transform = `scale(${s})`;
  }

  function renderSchematic(model){
    const colors = { top:"#f2f2f2", bot:"#f2f2f2", a:"#fff2e6", b:"#eefbf1" };
    const Wref = model.W_clamp;
    const pct = (realW)=>Math.max(30, Math.min(100, (realW / Wref) * 100));

    function barDiv({title, sub, kind, wPct, showInsert=false, insertText="", insertSide=""}){
      const bg = (kind==="TOP"||kind==="BOT") ? colors.top :
                 (kind==="A") ? colors.a :
                 (kind==="B") ? colors.b : "#fff";

      const boxClass =
        insertSide === "A" ? "insertBox insertBoxA" :
        insertSide === "B" ? "insertBox insertBoxB" :
        "insertBox";

      return `
        <div class="barRow">
          <div class="bar" style="width:${wPct}%;background:${bg}">
            <div class="barTitle">${title}</div>
            <div class="barSub">${sub}</div>
            ${showInsert ? `
              <div class="insertBadge">${insertText}</div>
              <div class="${boxClass}"></div>
            ` : ``}
          </div>
        </div>
      `;
    }

    const legPct = (model.W_leg / model.Wm) * 100;
    const winPct = (model.W_window / model.Wm) * 100;
    const gridStyle = `grid-template-columns:${legPct}% ${winPct}% ${legPct}%;`;

    const inlineWrapOpen  = `<div class="barRow"><div style="width:${pct(model.Wm)}%;">`;
    const inlineWrapClose = `</div></div>`;

    const hotInline = model.hasHot ? `
      ${inlineWrapOpen}
      <div class="inlineZone">
        <div class="zoneInner" style="${gridStyle}">
          <div class="leg">腳</div>
          <div class="window"><div class="chip chipHot">熱澆道（W_need=${Math.round(model.W_needA)}）</div></div>
          <div class="leg right">腳</div>
        </div>
      </div>
      ${inlineWrapClose}
    ` : ``;

    const ejectInline = `
      ${inlineWrapOpen}
      <div class="inlineZone">
        <div class="zoneInner" style="${gridStyle}">
          <div class="leg">腳</div>
          <div class="window">
            <div class="chip chipEj">上頂針板（W=${Math.round(model.W_eject)})</div>
            <div class="chip chipEj">下頂針板（W=${Math.round(model.W_eject)})</div>
          </div>
          <div class="leg right">腳</div>
        </div>
      </div>
      ${inlineWrapClose}
    `;

    const html = `
      <div class="schemViewport">
        <div class="schemCanvas">
          <div class="schemWrap">
            <div class="schemLeft">
              <div class="line"><b>模座</b>：${Math.round(model.Lm)}×${Math.round(model.Wm)}</div>
              <div class="line"><b>封頂板寬</b>：${Math.round(model.W_clamp)}</div>
              <div class="line"><b>Wins</b>：${Math.round(model.WinsEq)}</div>
              <div class="line"><b>W_need（Hot A）</b>：${model.hasHot ? Math.round(model.W_needA) : "-"}</div>
              <div class="line"><b>拆寬</b>：W_leg=${model.W_leg}｜W_window=${Math.round(model.W_window)}</div>
              <div class="line"><b>B 模腳高度</b>：${Math.round(model.H_legB)}</div>
              ${model.hasHot ? `<div class="line"><b>A 母模腳厚度</b>：${Math.round(model.H_spacerA)}（固定）</div>` : ``}
            </div>

            <div class="stackFrame">
              ${barDiv({ title:"上封頂板", sub:`t=${model.T_top}｜W=${Math.round(model.W_clamp)}`, kind:"TOP", wPct:pct(model.W_clamp) })}
              ${hotInline}

              ${barDiv({
                title:"母模板 A",
                sub:`t=${Math.round(model.TA_total)}｜W=${Math.round(model.Wm)}`,
                kind:"A", wPct:pct(model.Wm),
                showInsert:model.showInsert,
                insertText:`母模仁區域（示意） ${Math.round(model.Lins)}×${Math.round(model.Wins)}`,
                insertSide:"A"
              })}

              <div class="partingLine" aria-label="分模面"></div>

              ${barDiv({
                title:"公模板 B",
                sub:`t=${Math.round(model.TB_total)}｜W=${Math.round(model.Wm)}`,
                kind:"B", wPct:pct(model.Wm),
                showInsert:model.showInsert,
                insertText:`公模仁區域（示意） ${Math.round(model.Lins)}×${Math.round(model.Wins)}`,
                insertSide:"B"
              })}

              ${model.supportSeparate ? barDiv({ title:"支撐板", sub:`t=${model.T_support}｜W=${Math.round(model.Wm)}`, kind:"TOP", wPct:pct(model.Wm) }) : ""}

              ${ejectInline}

              ${barDiv({ title:"下封頂板", sub:`t=${Math.round(model.T_bottom)}｜W=${Math.round(model.W_clamp)}`, kind:"BOT", wPct:pct(model.W_clamp) })}
            </div>

            <div class="schemLegend">
              <div style="font-weight:800;color:#333;margin-bottom:6px;">圖例</div>
              <div class="k"><span class="swatch" style="background:#f2f2f2"></span>封頂板（更寬）</div>
              <div class="k"><span class="swatch" style="background:#d6d6d6"></span>模腳（左右對稱）</div>
              <div class="k"><span class="swatch" style="background:#fff;border-color:#d0d0d0"></span>中央可用寬（W_window）</div>
              <div class="k"><span class="swatch" style="background:rgba(255,246,240,.72)"></span>模仁區（A）</div>
              <div class="k"><span class="swatch" style="background:rgba(242,250,255,.70)"></span>模仁區（B）</div>
            </div>
          </div>
        </div>
      </div>
    `;
    $("schematic").innerHTML = html;

    requestAnimationFrame(() => {
      applySchematicScale();
      requestAnimationFrame(applySchematicScale);
    });
  }

  function updatePreview(){
    syncHotQtyUI();
    showWarn(""); showOk("");

    const cls = $("MoldSizeClass").value;
    const gate = $("GateType").value;


    const hasHot = (gate === "Hot");
    syncHotQtyUI();
    const hotQty = hasHot ? (parseInt(($("HotQty")?.value ?? "1"), 10) || 1) : 0;

    const Lp = +$("Lp").value;
    const Wp = +$("Wp").value;

    const {Wm} = estimateLmWm();
    const {DB, Hp} = estimateDA_DB_Hp();

    $("EjectStrokeHp").value = "";
    $("EjectStrokeDb").value = "";

    if(!(Wm > 0 && Lp>0 && Wp>0)){
      $("WLegOut").value = "";
      $("WWindowOut").value = "";
      $("WidthCheck").value = "";
      $("LegHeightBOut").value = "";
      $("TotalDeflectionOut").value = "";
      return;
    }

    const mIns = P.insertMargin[cls];
    const WinsEq = Wp + 2*mIns;

    const ww = computeLegWindowFromWins(Wm, WinsEq, gate, cls);
    $("WLegOut").value = ww.W_leg;
    $("WWindowOut").value = Math.round(ww.W_window);
    $("WidthCheck").value = `2*${ww.W_leg} + ${Math.round(ww.W_window)} = ${2*ww.W_leg + Math.round(ww.W_window)} (Wm=${Math.round(Wm)})`;

    if(ww.msg) showWarn(ww.msg);

    const preload = getPreload();
    const eject = getEjectStroke(DB, Hp);
    if(!(eject >= 0)){
      $("LegHeightBOut").value = "";
      $("TotalDeflectionOut").value = "";
      return;
    }
    const total = eject + preload;
    $("LegHeightBOut").value = Math.round(total);
    $("TotalDeflectionOut").value = Math.round(total);
  }

  function calculate(){
    showWarn(""); showOk("");

    const Lp = +$("Lp").value, Wp = +$("Wp").value;
    if(!(Lp>0 && Wp>0)){ showWarn("❗請輸入 Lp/Wp（>0）。"); return; }

    const cls = $("MoldSizeClass").value;
    const construct = $("MoldConstruction").value;
    const gate = $("GateType").value;

    const {Lm, Wm} = estimateLmWm();
    const W_clamp = estimateWClamp(Wm);

    const {DA, DB, Hp} = estimateDA_DB_Hp();
    if(!(DA>0 && DB>0 && Hp>0)){ showWarn("❗分模資料不足（Auto 或 Manual 未完成）。"); return; }

    const preload = getPreload();
    const ejectStroke = getEjectStroke(DB, Hp);
    if(!(ejectStroke >= 0)){ showWarn("❗頂出行程資料不足。"); return; }

    const H_legB = ejectStroke + preload;
    $("LegHeightBOut").value = Math.round(H_legB);
    $("TotalDeflectionOut").value = Math.round(H_legB);

    let warnMsg = "";
    if(H_legB > WARN_DEFLECTION){
      warnMsg += `⚠️ 總壓縮量（EjectStroke+Preload）= ${Math.round(H_legB)} mm，偏大（>${WARN_DEFLECTION}）。請確認 Hp 或 Preload。<br>`;
    }

    const supportMode = $("SupportPlateMode").value;
    const bottomThicken = +$("BottomThicken").value || 0;
    const T_top = P.topClamp[cls];
    const T_bottom = T_top + bottomThicken;
    const T_support = P.support[cls];

    let T_ep_u = +$("EjectPlateBaseT").value || 30;
    let T_ep_l = +$("EjectPlateBaseT").value || 30;
    if($("EjectThickenMode").value === "On"){
      if(ejectStroke > 120){ T_ep_u += 5; T_ep_l += 5; }
      if(ejectStroke > 180){ T_ep_u += 5; T_ep_l += 5; }
    }

    const hasHot = (gate === "Hot");
    // ✅ 修正 1：A 側母模腳厚度固定 70（只要 Hot）
    const H_spacerA = hasHot ? HOT_A_SPACER_FIXED : 0;

    const mIns = P.insertMargin[cls];
    const WinsEq = Wp + 2*mIns;
    const LinsEq = Lp + 2*mIns;

    const W_needA = hasHot ? Math.max(WinsEq, P.hotMinW[cls]) : WinsEq;

    const ww = computeLegWindowFromWins(Wm, WinsEq, gate, cls);
    const W_leg = ww.W_leg;
    const W_window = ww.W_window;
    $("WLegOut").value = W_leg;
    $("WWindowOut").value = Math.round(W_window);
    $("WidthCheck").value = `2*${W_leg} + ${Math.round(W_window)} = ${2*W_leg + Math.round(W_window)} (Wm=${Math.round(Wm)})`;

    if(ww.msg) warnMsg += ww.msg + "<br>";

    let W_eject = WinsEq;
    if(W_eject > W_window){
      warnMsg += `⚠️ 頂針板寬 Wins=${Math.round(W_eject)} > 中央可用寬 W_window=${Math.round(W_window)}，請提高等級/加大 Wm。BOM 暫以 W_window=${Math.round(W_window)} 計。<br>`;
      W_eject = Math.max(1, Math.floor(W_window));
    }

    let TA_total=0, TB_total=0;
    let Lins=0, Wins=0, TinsA=0, TinsB=0;

    if(construct === "Solid"){
      TA_total = DA + P.A_back_solid[cls] + (hasHot ? P.hotAllowance : 0);
      TB_total = DB + P.B_eject_solid[cls];
      if(supportMode === "Merged") TB_total += T_support;

      Lins = LinsEq; Wins = WinsEq;
    }else{
      Lins = LinsEq;
      Wins = WinsEq;

      TinsA = DA + P.insertBackA[cls] + (hasHot ? P.hotAllowance : 0);
      TinsB = DB + P.insertBackB[cls];

      TA_total = Math.max(P.A_plate_insert[cls], TinsA + P.t_underA[cls]);
      TB_total = Math.max(P.B_plate_insert[cls], TinsB + P.t_underB[cls]);
      if(supportMode === "Merged") TB_total += T_support;
    }

    // ✅ A/B 成型板 BOM 採購厚度：淨厚 + Hp + 加工餘量（示意圖維持淨厚）
    const t_mach = P.machAllow[cls];
    const TA_stock = TA_total + Hp + t_mach;
    const TB_stock = TB_total + Hp + t_mach;

    const rows = [];
    rows.push(rowItem("上封頂板", Lm, W_clamp, T_top, 1));


    // ✅ 熱澆道（外購件）：只顯示數量，不計體積/重量
    if(hasHot){
      rows.push(rowExternal("熱澆道（組）", hotQty));
    }

    if(hasHot){
      rows.push(rowItem("母模腳（A，側框｜固定70）", Lm, W_leg, H_spacerA, 2));
      rows.push(rowItem("熱澆道視窗板（A，中間｜固定70）", Lm, Math.round(W_window), H_spacerA, 1));
    }

    rows.push(rowItem("母模板（A 成型板｜含Hp+加工餘量）", Lm, Wm, TA_stock, 1));
    rows.push(rowItem("公模板（B 成型板｜含Hp+加工餘量）", Lm, Wm, TB_stock, 1));

    if(construct === "Insert"){
      rows.push(rowItem("母模仁（Insert）", Lins, Wins, TinsA, 1));
      rows.push(rowItem("公模仁（Insert）", Lins, Wins, TinsB, 1));
    }

    if(supportMode === "Separate") rows.push(rowItem("支撐板（全尺寸）", Lm, Wm, T_support, 1));

    rows.push(rowItem("公模腳（B，側框）", Lm, W_leg, H_legB, 2));
    rows.push(rowItem("上頂針板（中間，W=Wins）", Lm, W_eject, T_ep_u, 1));
    rows.push(rowItem("下頂針板（中間，W=Wins）", Lm, W_eject, T_ep_l, 1));

    rows.push(rowItem("下封頂板", Lm, W_clamp, T_bottom, 1));

    let html="", totalVol=0, totalWt=0;
    rows.forEach(r=>{
      totalVol += r.vol_cm3; totalWt += r.wt_kg;
      html += `<tr>
        <td>${r.name}</td><td>${r.size}</td><td>${r.qty}</td>
        <td>${r.vol_cm3.toFixed(0)}</td><td>${r.wt_kg.toFixed(0)}</td>
      </tr>`;
    });
    html += `<tr class="totalRow"><td>合計</td><td>-</td><td>-</td><td>${totalVol.toFixed(0)}</td><td>${totalWt.toFixed(0)}</td></tr>`;
    $("bom").innerHTML = html;

    if(warnMsg) showWarn(warnMsg);
    showOk(`✅ 計算完成<br>
      EjectStroke=${Math.round(ejectStroke)}｜Preload=${Math.round(preload)}｜B模腳高度=${Math.round(H_legB)}<br>
      Hot(A)母模腳厚度=${hasHot ? Math.round(H_spacerA) : "-"}（固定）<br>
      Wins=${Math.round(WinsEq)}｜HotNeed=${hasHot ? Math.round(W_needA) : "-"}｜W_leg=${W_leg}｜W_window=${Math.round(W_window)}<br>
      A/B 成型板採購厚度：A=${Math.round(TA_stock)}｜B=${Math.round(TB_stock)}（淨厚+Hp+加工餘量）<br>
      總重量：約 ${totalWt.toFixed(0)} kg`);

    renderSchematic({
      Lm, Wm, W_clamp,
      T_top, T_bottom,
      TA_total, TB_total,     // ✅ 示意圖維持淨厚
      hasHot, H_spacerA,
      T_ep_u, T_ep_l,
      supportSeparate: (supportMode === "Separate"),
      T_support,
      W_leg, W_window,
      H_legB,
      showInsert: (construct === "Insert"),
      Lins, Wins,
      WinsEq,
      W_needA,
      W_eject
    });
  }

    // ✅ 修正：包 try/catch，避免手機/桌機按鈕看起來「沒反應」
  function safeCalculate(){
    try{
      calculate();
    }catch(err){
      console.error(err);
      // 盡量把錯誤顯示在頁面上
      try{
        const msg = (err && (err.stack || err.message)) ? (err.stack || err.message) : String(err);
        showWarn(`❗計算發生錯誤：<br><pre style="white-space:pre-wrap;margin:8px 0 0">${msg}</pre>`);
      }catch(_){
        alert('計算發生錯誤，請在電腦開發者工具查看 Console。');
      }
    }
  }

// ✅ 修正 2：手機點擊兼容（click + touchend）
  function bindCalcButton(){
    const btn = $("calcBtn");
    if(!btn) return;

    btn.addEventListener("click", (e)=>{ e.preventDefault(); safeCalculate(); }, {passive:false});
    btn.addEventListener("touchend", (e)=>{ e.preventDefault(); safeCalculate(); }, {passive:false});
  }

  window.addEventListener("resize", () => requestAnimationFrame(applySchematicScale));

  function preset(type){
    if(type === "S"){
      $("Lp").value=200; $("Wp").value=150;
      $("MoldSizeClass").value="S";
      $("MoldConstruction").value="Solid";
      $("GateType").value="Cold";
      $("HasSlider").value="no";
      $("SplitMode").value="Auto";
      $("Hp").value=40;
      $("ASplitRatio").value=0.40;

      $("EjectMode").value="AutoHp";
      $("PreloadMode").value="Step";
      $("PreloadStep").value="15";

      $("EjectPlateBaseT").value="30";
      $("EjectThickenMode").value="On";

      $("SupportPlateMode").value="Merged";
      $("BottomThicken").value="0";
    }
    if(type === "L"){
      $("Lp").value=1200; $("Wp").value=500;
      $("MoldSizeClass").value="L";
      $("MoldConstruction").value="Insert";
      $("GateType").value="Hot";
      $("HotQty").value="1";
      $("HasSlider").value="no";
      $("SplitMode").value="Auto";
      $("Hp").value=40;
      $("ASplitRatio").value=0.40;

      $("EjectMode").value="AutoHp";
      $("PreloadMode").value="Step";
      $("PreloadStep").value="15";

      $("EjectPlateBaseT").value="35";
      $("EjectThickenMode").value="On";

      $("SupportPlateMode").value="Merged";
      $("BottomThicken").value="0";
    }
    if(type === "XL"){
      $("Lp").value=2000; $("Wp").value=600;
      $("MoldSizeClass").value="XL";
      $("MoldConstruction").value="Insert";
      $("GateType").value="Hot";
      $("HotQty").value="1";
      $("HasSlider").value="yes";
      $("SplitMode").value="ManualHeights";
      $("Hcav").value=160;
      $("Hcore").value=260;

      $("EjectMode").value="AutoHp";
      $("PreloadMode").value="Manual";
      $("PreloadManual").value="20";

      $("EjectPlateBaseT").value="40";
      $("EjectThickenMode").value="On";

      $("SupportPlateMode").value="Separate";
      $("BottomThicken").value="10";
    }

    syncSplitUI();
    syncEjectUI();
    syncPreloadUI();
    updatePreview();

    showWarn("");
    showOk("已載入自測案例，按「計算材料」即可。");
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    syncHotQtyUI();
    syncSplitUI();
    syncEjectUI();
    syncPreloadUI();
    updatePreview();
    bindCalcButton();
  });
</script>
</body>
</html>