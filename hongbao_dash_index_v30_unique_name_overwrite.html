<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>æ¶ç´…åŒ…å¿«é–ƒï½œæ–°å¹´äº’å‹•è³€å¡</title>
  <style>
    :root{
      --bg0:#090404;
      --bg1:#160b0b;
      --gold:#f7d37a;
      --red:#ff4d4d;
      --muted:rgba(255,255,255,.72);
      --muted2:rgba(255,255,255,.55);
    }
    *{box-sizing:border-box;font-family: ui-sans-serif, system-ui, -apple-system, "PingFang TC", "Noto Sans TC", "Segoe UI", sans-serif;}
    html,body{height:100%;margin:0;background:radial-gradient(1200px 900px at 50% 20%, #3a1414 0%, var(--bg1) 40%, var(--bg0) 100%);color:#fff;overflow:hidden}
    #wrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;}
    canvas{position:absolute;inset:0;width:100%;height:100%;touch-action:none;pointer-events:auto;}
    .ui{position:absolute;inset:0;pointer-events:none;}
    .hud{position:absolute;top:calc(env(safe-area-inset-top, 0px) + 10px);left:14px;right:14px;display:flex;gap:10px;align-items:center;justify-content:space-between;}
    .pill{
      background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(0,0,0,.38));
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(10px);
      border-radius:16px;padding:10px 12px;min-width:92px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .pill .k{font-size:11px;color:var(--muted2);letter-spacing:.10em}
    .pill .v{font-size:18px;font-weight:900;line-height:1.1;margin-top:2px}
    .pill.big .v{font-size:22px}
    .right{display:flex;gap:10px;align-items:center}
    .btnRow{position:absolute;left:0;right:0;bottom:18px;display:flex;justify-content:center;gap:12px;pointer-events:auto;padding:0 16px}
    .btn{
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.35));
      color:#fff;border-radius:18px;padding:14px 16px;font-weight:900;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      user-select:none;touch-action:manipulation;
      display:flex;align-items:center;gap:10px
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      padding:16px 18px;border-radius:22px;
      background:linear-gradient(180deg, rgba(255,77,77,.26), rgba(0,0,0,.35));
      border:1px solid rgba(255,77,77,.45);
    }
    .btn.small{padding:10px 12px;border-radius:14px;font-weight:800}
    .iconDot{width:10px;height:10px;border-radius:999px;background:var(--gold);box-shadow:0 0 0 3px rgba(247,211,122,.18)}
    .overlay{
      position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      padding:18px;pointer-events:auto;
      background:radial-gradient(900px 700px at 50% 15%, rgba(255,215,160,.14) 0%, rgba(0,0,0,.45) 50%, rgba(0,0,0,.74) 100%);
    }
    .card{
      width:min(560px, 92vw);
      background:linear-gradient(180deg, rgba(255,255,255,.11), rgba(0,0,0,.48));
      border:1px solid rgba(255,255,255,.14);
      border-radius:26px;
      padding:18px 18px 16px;
      box-shadow: 0 26px 80px rgba(0,0,0,.60);
      backdrop-filter: blur(12px);
      position:relative;
      overflow:hidden;
    }
    .card:before{
      content:"";position:absolute;inset:-2px;opacity:.60;
      background:
        radial-gradient(620px 200px at 50% 0%, rgba(247,211,122,.40), transparent 65%),
        radial-gradient(520px 240px at 0% 30%, rgba(255,77,77,.24), transparent 70%),
        radial-gradient(520px 240px at 100% 30%, rgba(255,77,77,.20), transparent 70%);
      pointer-events:none;
    }
    .title{position:relative;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .title h1{margin:0;font-size:22px;letter-spacing:.02em}
    .subtitle{position:relative;margin-top:6px;color:var(--muted);font-size:13px;line-height:1.7}
    .rules{position:relative;margin:12px 0 10px;padding:12px;border-radius:18px;background:rgba(0,0,0,.22);border:1px solid rgba(255,255,255,.10)}
    .rules ul{margin:0;padding-left:18px;color:var(--muted);font-size:13px;line-height:1.9}
    .grid{position:relative;display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}
    .stat{background:rgba(0,0,0,.20);border:1px solid rgba(255,255,255,.10);border-radius:18px;padding:12px}
    .stat .k{font-size:11px;color:var(--muted2);letter-spacing:.10em}
    .stat .v{font-size:20px;font-weight:950;margin-top:2px}
    .footer{position:relative;margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,.10);color:var(--muted);font-size:12px;line-height:1.7}
    .footer b{color:#fff}
    .row{position:relative;display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .toast{
      position:absolute;left:50%;transform:translateX(-50%);
      bottom:96px;min-width:220px;max-width:86vw;
      background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.14);
      padding:10px 12px;border-radius:16px;color:#fff;font-size:13px;
      backdrop-filter: blur(10px);
      opacity:0;transition:opacity .18s ease, transform .18s ease;
      pointer-events:none;
    }
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-6px)}
    .hint{
      position:absolute;
      top:calc(env(safe-area-inset-top, 0px) + 96px);
      left:50%;
      transform:translateX(-50%);
      color:rgba(255,255,255,.78);
      font-size:11px;
      line-height:1.35;
      letter-spacing:.06em;
      text-align:center;
      padding:0 14px;
      max-width:min(92vw, 560px);
      white-space:normal;
    }
    .comboBarWrap{
      position:absolute;left:14px;right:14px;top:calc(env(safe-area-inset-top, 0px) + 128px);height:10px;
      background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.10);
      border-radius:999px;overflow:hidden;pointer-events:none;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.18);
    }
    .comboBar{
      height:100%;width:0%;
      background:linear-gradient(90deg, rgba(247,211,122,.9), rgba(255,77,77,.75));
      border-radius:999px;
      box-shadow: 0 0 18px rgba(247,211,122,.30);
      transition:width .08s linear;
    }
    .badge{
      position:absolute;left:50%;transform:translateX(-50%);
      top:calc(env(safe-area-inset-top, 0px) + 146px);font-size:11px;color:rgba(255,255,255,.75);
      letter-spacing:.08em;pointer-events:none;
    }
    .hide{display:none !important;}
  
    @media (max-width: 420px){
      .pill{min-width:78px;padding:9px 10px;border-radius:14px}
      .pill .v{font-size:16px}
      .pill.big .v{font-size:20px}
      .hud{gap:8px}
      .right{gap:8px}
      #soundBtn{padding:9px 10px}
      .hint{font-size:10.5px; letter-spacing:.04em}
      .badge{font-size:10px}
    }

  
/* Phase 2 inputs */
.phase2{margin-top:14px;padding:12px;border:1px solid rgba(255,255,255,.08);border-radius:14px;background:rgba(0,0,0,.14)}
.phase2Title{font-size:12px;color:var(--muted2);margin-bottom:10px}
.phase2Form{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:720px){.phase2Form{grid-template-columns:1fr}}
.field .label{font-size:12px;color:var(--muted2);margin-bottom:6px}
.field input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);color:rgba(255,255,255,.92);outline:none}
.field input:focus{border-color:rgba(247,211,122,.55);box-shadow:0 0 0 4px rgba(247,211,122,.10)}
.field .hint{font-size:11px;color:rgba(255,255,255,.45);margin-top:6px}
.chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.chip{border-radius:999px;padding:7px 10px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.06);color:rgba(255,255,255,.82);cursor:pointer}
.chip:active{transform:translateY(1px)}
.submitRow{display:flex;align-items:center;gap:10px;margin-top:12px}
.submitState{font-size:12px;color:rgba(255,255,255,.60)}
.submitState.ok{color:rgba(120,255,170,.85)}
.submitState.bad{color:rgba(255,120,120,.85)}
.btn:disabled{opacity:.5;cursor:not-allowed}


/* Leaderboard */
.lbHeader{margin-bottom:12px}
.lbTitle{font-size:18px;font-weight:800;letter-spacing:.5px}
.lbSub{font-size:12px;color:rgba(255,255,255,.65);margin-top:6px}
.lbPanel{margin-top:10px;border:1px solid rgba(255,255,255,.10);border-radius:14px;overflow:hidden;background:rgba(0,0,0,.20)}
.lbHeadRow{display:grid;grid-template-columns:48px 1.1fr 110px 2fr;gap:10px;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08);font-size:12px;color:rgba(255,255,255,.65);background:rgba(255,255,255,.03)}
.lbList{max-height:340px;overflow:auto}
.lbRow{display:grid;grid-template-columns:48px 1.1fr 110px 2fr;gap:10px;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06);align-items:center}
.lbRow:last-child{border-bottom:none}
.lbRow .rank{color:rgba(255,255,255,.65);font-variant-numeric:tabular-nums}
.lbRow .name{font-weight:700}
.lbRow .score{font-variant-numeric:tabular-nums;font-weight:800}
.lbRow .msg{color:rgba(255,255,255,.75);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.lbRow.me{background:linear-gradient(90deg, rgba(247,211,122,.16), rgba(255,120,120,.06))}
.lbFooter{display:flex;justify-content:space-between;align-items:center;margin-top:12px;gap:10px}
.brandLine{color:rgba(255,255,255,.65);font-size:12px}
.lbActions{display:flex;gap:10px}
@media (max-width:720px){
  .lbHeadRow,.lbRow{grid-template-columns:38px 1fr 90px 1.4fr}
  .lbList{max-height:46vh}
}

</style>
</head>
<body>
  <div id="wrap">
    <canvas id="c"></canvas>

    <div class="ui">
      <div class="hud">
        <div class="pill big">
          <div class="k">æ™‚é–“</div>
          <div class="v" id="timeV">60.0</div>
        </div>
        <div class="right">
          <div class="pill">
            <div class="k">åˆ†æ•¸</div>
            <div class="v" id="scoreV">0</div>
          </div>
          <div class="pill">
            <div class="k">COMBO</div>
            <div class="v" id="comboV">x1</div>
          </div>
          <button class="btn small" id="soundBtn" title="éŸ³æ•ˆ" style="pointer-events:auto">
            <span class="iconDot"></span><span id="soundLbl">éŸ³æ•ˆï¼šé–‹</span>
          </button>
        </div>
      </div>

      <div class="comboBarWrap"><div class="comboBar" id="comboBar"></div></div>
      <div class="badge" id="badge">æ¶ç´…åŒ…ï¼šé€£æ“Šå‡å€ç‡</div>

      <div class="hint" id="hint">ç›´æ¥é»ç•«é¢ç‰©ä»¶æ¶åˆ†ï¼šğŸ§§/ğŸª™/ğŸ® åŠ åˆ†ï½œğŸ‘¹/ğŸ’£ æ‰£åˆ†æ–·é€£æ“Šï½œç©ºé»æœƒæ‰£åˆ†ï½œå¶çˆ¾æ‰ä¸‹ âœ¨è¶…å¤§ç´…åŒ…âœ¨</div>
<div class="toast" id="toast"></div>

      <div class="overlay" id="startOverlay">
        <div class="card">
          <div class="title">
            <h1>æ¶ç´…åŒ…å¿«é–ƒ</h1>
            <div style="font-size:12px;color:var(--muted2);text-align:right">
              60 ç§’è¡æ¦œ<br><span style="color:var(--gold)">é€£æ“Š</span> åŠ å€ç‡
            </div>
          </div>
          <div class="subtitle">
            ç´…åŒ…é›¨ä¾†äº†ï¼ç”¨æ‰‹æŒ‡å»ã€Œé»ã€ç•«é¢ä¸Šçš„ç‰©ä»¶æ¶åˆ†ã€‚<br>
            <span style="color:var(--muted2)">æç¤ºï¼šäº‚é»æœƒé™å€ç‡ï¼›çœ‹åˆ° âœ¨è¶…å¤§ç´…åŒ…âœ¨ åˆ¥çŒ¶è±«ï¼</span>
          </div>

          <div class="rules">
            <ul>
              <li>åŠ åˆ†ï¼šğŸ§§ç´…åŒ…ã€ğŸª™å…ƒå¯¶ã€ğŸ®ç‡ˆç± ï¼ˆé€£æ“Šå‡å€ç‡ï¼‰</li>
              <li>æ‰£åˆ†ï¼šğŸ‘¹å¹´ç¸ã€ğŸ’£ç‚¸å½ˆï¼ˆæ‰£åˆ†ï¼‹æ–· Comboï¼‰</li>
              <li>é€£çºŒç©ºé»ï¼šæ‰£åˆ†ï¼ˆå€ç‡ä¸è®Šï¼‰</li>
              <li>ç¨€æœ‰ï¼šâœ¨è¶…å¤§ç´…åŒ…âœ¨ å‡ºç¾å¾ˆçŸ­ï¼Œé»åˆ°å¤§åŠ åˆ†ï¼</li>
            </ul>
          </div>

          
<div class="row">
            <button class="btn primary" id="startBtn">é–‹å§‹éŠæˆ²</button>
            <button class="btn" id="howBtn">æˆ‘æ€éº¼ç©ï¼Ÿ</button>
          </div>

          <div class="footer">
            <div><b id="companyName">å¼˜é¨èˆˆæ¥­æœ‰é™å…¬å¸</b> ï½œ <span id="blessing">æ–°å¹´å¿«æ¨‚ãƒ»Balance &amp; Peace</span></div>
            <div style="color:var(--muted2);margin-top:4px">ï¼ˆå¯ç¾¤ç™¼ï¼šåŒä¸€å€‹é€£çµæ‰€æœ‰äººéƒ½èƒ½ç©ï¼‰</div>
          </div>
        </div>
      </div>

      <div class="overlay hide" id="endOverlay">
        <div class="card">
          <div class="title">
            <h1>æˆç¸¾çµç®—</h1>
            <div style="font-size:12px;color:var(--muted2);text-align:right">
              æ¶åˆ°å¤šå°‘çœ‹ä½ äº†<br><span style="color:var(--gold)">æ­å–œç™¼è²¡</span>
            </div>
          </div>

          <div class="grid">
            <div class="stat">
              <div class="k">æœ¬æ¬¡åˆ†æ•¸</div>
              <div class="v" id="finalScore">0</div>
            </div>
            <div class="stat">
              <div class="k">æœ€é«˜å€ç‡</div>
              <div class="v" id="finalMult">x1</div>
            </div>
            <div class="stat">
              <div class="k">Perfect æ¬¡æ•¸</div>
              <div class="v" id="finalPerfect">0</div>
            </div>
            <div class="stat">
              <div class="k">æœ¬æ©Ÿæœ€é«˜åˆ†</div>
              <div class="v" id="bestScore">0</div>
            </div>
          </div>

          <div class="phase2">
            <div class="phase2Title">ç•™ä¸‹ä½ çš„åå­—èˆ‡ç¥ç¦ï¼ˆä¸Šæ¦œç”¨ï¼‰</div>
            <div class="phase2Form">
              <div class="field">
                <div class="label">åå­—æˆ–æš±ç¨±ï¼ˆå¿…å¡«ï¼‰</div>
                <input id="nameInput" maxlength="12" placeholder="è¼¸å…¥åå­—æˆ–æš±ç¨±" autocomplete="off" />
                <div class="hint">æœ€å¤š 12 å­—</div>
              </div>

              <div class="field">
                <div class="label">ç¥ç¦èªï¼ˆå¯ç•™ç©ºï¼‰</div>
                <input id="msgInput" maxlength="40" placeholder="ç•™ä¸€å¥ç¥ç¦å§ï½" autocomplete="off" />
                <div class="chips" id="msgChips">
                  <button class="chip" type="button">æ–°å¹´å¿«æ¨‚ ğŸ‰</button>
                  <button class="chip" type="button">æ­å–œç™¼è²¡ ğŸ§§</button>
                  <button class="chip" type="button">å¹³å®‰é †å¿ƒ âœ¨</button>
                  <button class="chip" type="button">å¥½é‹é€£é€£ ğŸ€</button>
                  <button class="chip" type="button">å¤©å¤©å¥½å¿ƒæƒ… ğŸ˜Š</button>
                </div>
              </div>
            </div>

            <div class="submitRow">
              <button class="btn primary" id="submitBtn">é€å‡ºä¸Šæ¦œ</button>
              <div class="submitState" id="submitState">å°šæœªé€å‡º</div>
            </div>
          </div>

          <div class="row" style="margin-top:14px">
            <button class="btn primary" id="retryBtn">å†ç©ä¸€æ¬¡</button>
            <button class="btn" id="shareBtn">åˆ†äº«æˆç¸¾ï¼ˆè¤‡è£½ï¼‰</button>
            <button class="btn" id="shareCardBtn">åˆ†äº«æˆç¸¾å¡ï¼ˆä¸‹è¼‰PNGï¼‰</button>
          </div>

          <div class="footer">
            <div><b id="companyName2">å¼˜é¨èˆˆæ¥­æœ‰é™å…¬å¸</b> ï½œ <span id="blessing2">æ–°å¹´å¿«æ¨‚ãƒ»Balance &amp; Peace</span></div>
            <div style="color:var(--muted2);margin-top:4px">æŠŠæˆç¸¾è²¼åˆ° LINE ç¾¤çµ„å°±èƒ½æ¯”é«˜åˆ†ã€‚</div>
          </div>
        </div>
      </div>

      <div class="overlay hide" id="howOverlay">
        <div class="card">
          <div class="title">
            <h1>å¿«é€Ÿæ•™å­¸</h1>
            <button class="btn small" id="closeHow" style="pointer-events:auto">é—œé–‰</button>
          </div>
          <div class="rules" style="margin-top:12px">
            <ul>
              <li>ç›´æ¥é»ç•«é¢ä¸Šçš„ç‰©ä»¶ï¼ˆä¸ç”¨æŒ‰æŒ‰éˆ•ï¼‰</li>
              <li>ğŸ§§/ğŸª™/ğŸ® åŠ åˆ†ä¸¦ç–Šå€ç‡</li>
              <li>ğŸ‘¹/ğŸ’£ æ‰£åˆ†ä¸¦æ–· Combo</li>
              <li><b>é€£çºŒç©ºé»æœƒæ‰£åˆ†</b>ï¼ˆé˜²äº‚é»ï¼‰</li>
              <li>âœ¨è¶…å¤§ç´…åŒ…âœ¨ å‡ºç¾å¾ˆçŸ­ï¼Œé»åˆ°å¤§åŠ åˆ†ï¼‹ç‰¹æ•ˆ</li>
            </ul>
          </div>
          <div class="row">
            <button class="btn primary" id="closeHow2">æˆ‘æ‡‚äº†</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
// Ensure bindings after DOM ready
document.addEventListener('DOMContentLoaded', ()=>{

/* =========================
   CONFIGï¼ˆä½ å¯æ”¹çš„åœ°æ–¹ï¼‰
========================= */
const CONFIG = {
  durationSec: 60,

  // å€ç‡ï¼šæ¯ stepEvery æ¬¡ã€ŒåŠ åˆ†å‘½ä¸­ã€å‡ç´š
  combo: { stepEvery: 4, multipliers: [1,2,3,4,6] },

  // åŒæ™‚å­˜åœ¨ä¸Šé™ï¼ˆæœƒéš¨æ™‚é–“æå‡ï¼‰
  maxAlive: { early: 3, mid: 4, late: 6 },

  // ç”Ÿæˆé–“éš”ï¼ˆç§’ï¼‰ç¯„åœï¼šè¶Šå¾Œé¢è¶Šå¿«
  spawn: {
    early: {min: 0.42, max: 0.75},
    mid:   {min: 0.32, max: 0.62},
    late:  {min: 0.24, max: 0.48},
  },

  // ç‰©ä»¶å­˜æ´»æ™‚é–“ï¼ˆç§’ï¼‰
  ttl: {
    early: {min: 0.95, max: 1.25},
    mid:   {min: 0.78, max: 1.05},
    late:  {min: 0.62, max: 0.92},

    // ç¨€æœ‰è¶…å¤§ç´…åŒ…ï¼šå‡ºç¾å¾ˆçŸ­
    super: {min: 0.38, max: 0.55},
  },

  // ç‰©ä»¶æ¬Šé‡ï¼ˆè¶Šå¤§è¶Šå¸¸å‡ºç¾ï¼‰
  weights: {
    hongbao: 55,
    yuanbao: 10,
    lantern: 12,
    lion: 0,
    nian: 10,
    bomb: 7,

    // è¶…å¤§ç´…åŒ…ï¼ˆç¨€æœ‰ï¼‰
    super_hongbao: 2,
  },

  // åˆ†æ•¸ï¼ˆåŠ åˆ†æœƒä¹˜å€ç‡ï¼›æ‰£åˆ†ä¸ä¹˜å€ç‡ï¼‰
  points: {
    hongbao: 60,
    yuanbao: 140,
    lantern: 110,
    lion: 0,
    super_hongbao: 420,

    nian: -140,
    bomb: -220,
  },

  // ç©ºé»æ‡²ç½°ï¼šåœ¨ç©ºç™½è™•é€£é»é” threshold æ¬¡ï¼Œæ‰£ comboGoodTotal é€²åº¦ï¼ˆè‡³å°‘ä¸ä½æ–¼ 0ï¼‰
  emptyPenalty: {
    windowSec: 1.2,      // åˆ¤å®šé€£çºŒç©ºé»çš„æ™‚é–“çª—
    threshold: 3,        // é€£çºŒç©ºé»æ¬¡æ•¸
    scorePenalty: -120,  // è§¸ç™¼æ™‚æ‰£åˆ†ï¼ˆä¸å½±éŸ¿å€ç‡ï¼‰
  },

  // ç½²å
  companyName: "å¼˜é¨èˆˆæ¥­æœ‰é™å…¬å¸",
  blessing: "æ–°å¹´å¿«æ¨‚ãƒ»Balance & Peace",
  gameTitle: "æ¶ç´…åŒ…å¿«é–ƒ",
};

/* =========================
   Utilities
========================= */
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const rand=(a,b)=>a+Math.random()*(b-a);
const now=()=>performance.now()/1000;
const fmt1=n=>(Math.round(n*10)/10).toFixed(1);
const fmtInt=n=>Math.round(n).toString();
function haptic(ms=12){ if(navigator.vibrate) navigator.vibrate(ms); }

/* =========================
   DOM
========================= */
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d');

const timeV=document.getElementById('timeV');
const scoreV=document.getElementById('scoreV');
const comboV=document.getElementById('comboV');
const comboBar=document.getElementById('comboBar');
const badge=document.getElementById('badge');

const toast=document.getElementById('toast');
const hint=document.getElementById('hint');

const startOverlay=document.getElementById('startOverlay');
const endOverlay=document.getElementById('endOverlay');
const leaderboardOverlay=document.getElementById('leaderboardOverlay');
const lbList=document.getElementById('lbList');
const lbBackBtn=document.getElementById('lbBackBtn');
const lbAgainBtn=document.getElementById('lbAgainBtn');

function showLeaderboard(){
  if(!leaderboardOverlay) return;
  endOverlay.classList.add('hide');
  leaderboardOverlay.classList.remove('hide');
  loadLeaderboard().catch(err=>{
    console.error(err);
    if(lbList) lbList.innerHTML = `<div style="padding:14px;color:rgba(255,255,255,.75);">æ’è¡Œæ¦œè¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</div>`;
  });
}

async function loadLeaderboard(){
  if(!lbList) return;
  lbList.innerHTML = `<div style="padding:14px;color:rgba(255,255,255,.65);">è¼‰å…¥ä¸­â€¦</div>`;

  const snap = await db.collection('leaderboard_2026newyeargamecard')
    .orderBy('score','desc')
    .limit(100)
    .get();

  const rows = [];
  snap.forEach(doc=>{
    const d = doc.data()||{};
    rows.push({
      id: doc.id,
      name: (d.name||'').toString(),
      message: (d.message||'').toString(),
      score: Number(d.score||0),
      createdAt: d.createdAt && d.createdAt.toMillis ? d.createdAt.toMillis() : 0
    });
  });

  rows.sort((a,b)=> (b.score - a.score) || (a.createdAt - b.createdAt) || (a.id>b.id?1:-1));

  const meId = window.__lastDocId || '';
  lbList.innerHTML = rows.map((r,i)=>{
    const safeName = escapeHtml(r.name).slice(0,12) || 'â€”';
    const safeMsg = escapeHtml(r.message).slice(0,40) || '';
    const cls = (r.id===meId) ? 'lbRow me' : 'lbRow';
    return `<div class="${cls}">
      <div class="rank">#${i+1}</div>
      <div class="name" title="${safeName}">${safeName}</div>
      <div class="score">${r.score}</div>
      <div class="msg" title="${safeMsg}">${safeMsg}</div>
    </div>`;
  }).join('') || `<div style="padding:14px;color:rgba(255,255,255,.65);">ç›®å‰é‚„æ²’æœ‰æ¦œå–®ï¼Œå¿«ä¾†æ¶ç¬¬ä¸€ï¼</div>`;
}

function escapeHtml(str){
  return (str||'').replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
}

if(lbBackBtn){
  lbBackBtn.addEventListener('click', ()=>{
    leaderboardOverlay.classList.add('hide');
    endOverlay.classList.remove('hide');
  });
}
if(lbAgainBtn){
  lbAgainBtn.addEventListener('click', ()=>{ location.reload(); });
}

const howOverlay=document.getElementById('howOverlay');

const startBtn=document.getElementById('startBtn');
const howBtn=document.getElementById('howBtn');
const closeHow=document.getElementById('closeHow');
const closeHow2=document.getElementById('closeHow2');

const retryBtn=document.getElementById('retryBtn');
const shareBtn=document.getElementById('shareBtn');
const shareCardBtn=document.getElementById('shareCardBtn');
let nameInput=null;
let msgInput=null;
let msgChips=null;
let submitBtn=null;
let submitState=null;

let submitted=false;

function sanitizeText(str){
  return (str||"").replace(/[<>]/g,"").replace(/\s+/g," ").trim();
}
function nameKeyFrom(name){
  // deterministic doc id to avoid duplicate names on leaderboard
  const n = sanitizeText(name).toLowerCase();
  const key = n.replace(/\s+/g,'-').replace(/[^a-z0-9\u4e00-\u9fff\-]/g,'');
  return key.slice(0,24) || 'anon';
}
function validatePhase2(){
  const name = sanitizeText(nameInput?.value);
  if(submitBtn){
    submitBtn.disabled = (!name || name.length<1);
  }
}
function setSubmitState(type, text){
  if(!submitState) return;
  submitState.classList.remove('ok','bad');
  if(type) submitState.classList.add(type);
  submitState.textContent = text;
}

function bindPhase2Refs(){
  // Phase 2 elements live in endOverlay (avoid duplicate IDs)
  nameInput = endOverlay.querySelector('#nameInput');
  msgInput  = endOverlay.querySelector('#msgInput');
  msgChips  = endOverlay.querySelector('#msgChips');
  submitBtn = endOverlay.querySelector('#submitBtn');
  submitState = endOverlay.querySelector('#submitState');

  if(nameInput){ nameInput.oninput = validatePhase2; }
  if(msgInput){ msgInput.oninput = validatePhase2; }

  if(msgChips && msgInput){
    msgChips.querySelectorAll('.chip').forEach(btn=>{
      btn.onclick = ()=>{
        msgInput.value = btn.textContent;
        validatePhase2();
      };
    });
  }

  if(submitBtn){
    submitBtn.onclick = async ()=>{
      const name = sanitizeText(nameInput?.value);
      const message = sanitizeText(msgInput?.value);
      if(!name){
        setSubmitState('bad','è«‹å…ˆå¡«åå­—');
        return;
      }
      submitBtn.disabled = true;
      setSubmitState('', 'é€å‡ºä¸­â€¦');

      try{
        const nameKey = nameKeyFrom(name);
        const docRef = db.collection('leaderboard_2026newyeargamecard').doc(nameKey);
        await docRef.set({
          name,
          message,
          score: Number(score||0),
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          game: '2026newyeargamecard',
          v: 30,
          nameKey
        }, { merge: true });

        submitted = true;
        setSubmitState('ok','å·²é€å‡ºï¼Œæ­£åœ¨è¼‰å…¥æ’è¡Œæ¦œâ€¦');

        window.__lastDocId = nameKey;
        showLeaderboard();
      }catch(e){
        console.error(e);
        setSubmitState('bad','é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        submitBtn.disabled = false;
      }
    };
  }

  validatePhase2();
}

const soundBtn=document.getElementById('soundBtn');
const soundLbl=document.getElementById('soundLbl');

const finalScore=document.getElementById('finalScore');
const finalMult=document.getElementById('finalMult');
const finalPerfect=document.getElementById('finalPerfect');
const bestScoreEl=document.getElementById('bestScore');

document.getElementById('companyName').textContent=CONFIG.companyName;
document.getElementById('companyName2').textContent=CONFIG.companyName;
document.getElementById('blessing').textContent=CONFIG.blessing;
document.getElementById('blessing2').textContent=CONFIG.blessing;

/* =========================
   Audio (tiny synth)
========================= */
let audioOn=true;
let ac=null;
function beep(type='ok'){
  if(!audioOn) return;
  try{
    if(!ac) ac=new (window.AudioContext||window.webkitAudioContext)();
    const t0=ac.currentTime;
    const o=ac.createOscillator();
    const g=ac.createGain();
    o.type = type==='bad' ? 'triangle' : 'sine';
    const f = type==='super'?1020 : type==='good'?900 : type==='bad'?220 : 650;
    o.frequency.setValueAtTime(f,t0);
    g.gain.setValueAtTime(0.0001,t0);
    g.gain.exponentialRampToValueAtTime(type==='bad'?0.14:0.22,t0+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001,t0+0.14);
    o.connect(g); g.connect(ac.destination);
    o.start(t0); o.stop(t0+0.16);
  }catch(e){}
}

/* =========================
   Canvas sizing
========================= */
let W=0,H=0,dpr=1;
function resize(){
  dpr=Math.max(1,Math.min(2,window.devicePixelRatio||1));
  W=canvas.width=Math.floor(innerWidth*dpr);
  H=canvas.height=Math.floor(innerHeight*dpr);
  canvas.style.width=innerWidth+'px';
  canvas.style.height=innerHeight+'px';
  ctx.setTransform(1,0,0,1,0,0);
}
addEventListener('resize',resize); resize();

/* =========================
   Background: lanterns
========================= */
let lanterns=[];
function initLanterns(){
  lanterns=[];
  const count=Math.round(clamp(innerWidth/115, 7, 15));
  for(let i=0;i<count;i++){
    lanterns.push({
      x: rand(0,W), y: rand(0,H*0.56),
      r: rand(10,18)*dpr, sway: rand(0.8,1.8),
      phase: rand(0,Math.PI*2),
      speed: rand(0.05,0.12), glow: rand(0.35,0.75),
      depth: rand(0.6,1.0),
    });
  }
}
initLanterns(); addEventListener('resize',initLanterns);

/* =========================
   Entities + Particles
========================= */
let entities=[]; // {type,x,y,r,vx,vy,t,ttl,rot,isSuper}
let sparks=[];   // particles
let popups=[];   // floating text

function seg(elapsed){
  if(elapsed<20) return 'early';
  if(elapsed<45) return 'mid';
  return 'late';
}
function pickWeighted(){
  const entries = Object.entries(CONFIG.weights);
  const sum = entries.reduce((a,[,v])=>a+v,0);
  let r = Math.random()*sum;
  for(const [k,v] of entries){
    r -= v;
    if(r<=0) return k;
  }
  return 'hongbao';
}

function spawnEntity(elapsed){
  const s = seg(elapsed);
  const type = pickWeighted();
  const isSuper = type==='super_hongbao';

  const ttl = isSuper ? CONFIG.ttl.super : CONFIG.ttl[s];

  // keep away from bottom button a bit
  const safeBottom = 110*dpr;
  const x = rand(70*dpr, W-70*dpr);
  const y = rand(120*dpr, H - safeBottom);

  const baseR = (
    type==='lion'?48 :
    type==='bomb'?44 :
    type==='nian'?46 :
    type==='yuanbao'?42 :
    type==='lantern'?40 :
    type==='super_hongbao'?62 :
    44
  ) * dpr;

  const scale = rand(0.85, 1.18) * (type==='lion'?1.05: type==='super_hongbao'?1.08:1.0);
  const vx = rand(-22,22)*dpr * (isSuper?0.65:1.0);
  const vy = rand(-18,18)*dpr * (isSuper?0.65:1.0);

  entities.push({
    type, isSuper,
    x, y,
    r: baseR*scale,
    vx, vy,
    t: now(),
    ttl: rand(ttl.min, ttl.max),
    rot: rand(-0.25,0.25)
  });
}

function addSparks(x,y,kind){
  const n = kind==='super'?40 : kind==='good'?18:14;
  for(let i=0;i<n;i++){
    const a = rand(0,Math.PI*2);
    const sp = rand(140, 560) * dpr * (kind==='super'?1.1:1.0);
    sparks.push({x,y, vx:Math.cos(a)*sp, vy:Math.sin(a)*sp, t:now(), life:rand(0.30,0.75), kind});
  }
}
function addPopup(x,y,text,kind){
  popups.push({x,y,text,kind,t:now(),life:0.95});
}

/* =========================
   Game State
========================= */
const STATE={START:'start',PLAY:'play',END:'end'};
let state=STATE.START;

let tStart=0;
let tLeft=CONFIG.durationSec;
let score=0;

let comboGoodTotal=0; // ç”¨æ–¼å‡å€ç‡çš„åŠ åˆ†æ¬¡æ•¸
let maxMult=1;

let goodHits=0;
let badHits=0;
let perfectHits=0;
let okHits=0;
let missHits=0;

let nextSpawnAt=0;
let screenShake=0;
let flash=0;

// ç©ºé»æ‡²ç½°
let emptyStreak=0;
let lastEmptyAt=-999;

const LS_KEY="hongbao_dash_best_v11";
let best=Number(localStorage.getItem(LS_KEY)||0);

function multiplier(){
  const step = CONFIG.combo.stepEvery;
  const idx = clamp(Math.floor(comboGoodTotal/step), 0, CONFIG.combo.multipliers.length-1);
  return CONFIG.combo.multipliers[idx];
}
function updateComboUI(){
  const step=CONFIG.combo.stepEvery;
  const inStep = comboGoodTotal % step;
  const pct = (inStep/step)*100;
  comboBar.style.width = `${pct}%`;
  badge.textContent = `å€ç‡ x${multiplier()}ï½œå†åŠ åˆ† ${step-inStep} æ¬¡å‡ç´š`;
  comboV.textContent = "x"+multiplier();
  maxMult = Math.max(maxMult, multiplier());
}

function scheduleSpawn(elapsed){
  const s=seg(elapsed);
  const {min,max}=CONFIG.spawn[s];
  nextSpawnAt = now() + rand(min,max);
}
function maxAlive(elapsed){
  const s=seg(elapsed);
  return CONFIG.maxAlive[s];
}

function showToast(msg, kind){
  toast.textContent=msg;
  toast.classList.add('show');
  toast.style.borderColor = kind==='good' ? 'rgba(247,211,122,.35)' :
                            kind==='bad' ? 'rgba(255,77,77,.35)' :
                            'rgba(255,255,255,.18)';
  clearTimeout(showToast._t);
  showToast._t=setTimeout(()=>toast.classList.remove('show'),420);
}

function onGood(type, x, y, judgement="OK"){
  const base = CONFIG.points[type];
  const add = base * multiplier();
  score += add;
  goodHits++;
  comboGoodTotal++;
  emptyStreak=0;
  updateComboUI();

  const isSuper = (type==='super_hongbao');
  const vfxKind = isSuper ? 'super' : 'good';

  if(judgement==="Perfect") perfectHits++; else okHits++;

  // VFX layers
  addSparks(x,y, vfxKind);
  if(judgement==="Perfect") addSparks(x,y, vfxKind);

  // Text layers (Perfect/OK + score)
  addPopup(x,y-22*dpr, judgement, isSuper?'super':(judgement==="Perfect"?'perfect':'good'));
  addPopup(x,y+10*dpr, `+${add}`, isSuper?'super':'good');

  haptic(isSuper?16:(judgement==="Perfect"?14:10));
  beep(isSuper?'super':'good');

  screenShake = Math.max(screenShake, isSuper?12:(judgement==="Perfect"?8:4));

  // micro screen flash (for Perfect / Super)
  if(isSuper || judgement==="Perfect") flash = Math.max(flash, isSuper?0.22:0.14);

  showToast(isSuper ? "è¶…å¤§ç´…åŒ…ï¼" : (judgement==="Perfect" ? "Perfectï¼" : "æ¶åˆ°ï¼"), 'good');
}

function onBad(type, x, y, judgement="OK"){
  const base = CONFIG.points[type]; // negative
  score += base;
  badHits++;
  comboGoodTotal = 0;
  emptyStreak=0;
  updateComboUI();

  if(judgement==="Perfect") perfectHits++; else okHits++;
  addSparks(x,y,'bad');
  if(judgement==="Perfect") addSparks(x,y,'bad'); // sharp hit on trap still pops harder

  // Text layers (Perfect/OK + penalty)
  addPopup(x,y-22*dpr, judgement, judgement==="Perfect"?'perfect':'bad');
  addPopup(x,y+10*dpr, `${base}`, 'bad');

  haptic(12);
  beep('bad');
  screenShake = Math.max(screenShake, 10);
  flash = Math.max(flash, 0.10);

  showToast(type==='bomb'?'çˆ†äº†ï¼':'è¢«å¹´ç¸é™°äº†â€¦','bad');
}

function applyEmptyPenalty(px,py){
  const t=now();
  const {windowSec, threshold, scorePenalty} = CONFIG.emptyPenalty;

  if(t - lastEmptyAt <= windowSec) emptyStreak++;
  else emptyStreak = 1;

  lastEmptyAt = t;

  addPopup(px,py,"MISS","miss");
  missHits++;

  if(emptyStreak >= threshold){
    emptyStreak = 0;
    score += scorePenalty; // åªæ‰£åˆ†ï¼Œä¸å½±éŸ¿å€ç‡
    addSparks(px,py,'bad');
    addPopup(px,py,`${scorePenalty}`,'bad');
    showToast("äº‚é»æ‰£åˆ†",'bad');
    haptic(10);
    beep('bad');
    screenShake = Math.max(screenShake, 6);
  }
}

function hitTest(px,py){
  // return nearest hit + how close to center (for Perfect/OK)
  let bestI = -1;
  let bestD = 1e9;
  let bestR = 1;
  for(let i=0;i<entities.length;i++){
    const e = entities[i];
    const d = Math.hypot(px-e.x, py-e.y);
    if(d <= e.r && d < bestD){
      bestD = d;
      bestI = i;
      bestR = d / Math.max(1e-6, e.r); // 0=center, 1=edge
    }
  }
  return { i: bestI, ratio: bestR };
}

function pointerToCanvas(e){
  const rect = canvas.getBoundingClientRect();
  const x = (e.clientX - rect.left) * dpr;
  const y = (e.clientY - rect.top) * dpr;
  return {x,y};
}

function onTap(px,py){
  if(state!==STATE.PLAY) return;

  const res = hitTest(px,py);
  if(res.i < 0){
    applyEmptyPenalty(px,py);
    return;
  }
  const ent = entities[res.i];
  entities.splice(res.i,1);

  // Judge quality by how close to the center you tapped
  const judgement = (res.ratio <= 0.62) ? "Perfect" : "OK";

  if(ent.type==='nian' || ent.type==='bomb'){
    onBad(ent.type, ent.x, ent.y, judgement);
  }else{
    onGood(ent.type, ent.x, ent.y, judgement);
  }
}

 /* =========================
   Controls
========================= */
canvas.addEventListener('pointerdown', (e)=>{
  const {x,y} = pointerToCanvas(e);
  onTap(x,y);
}, {passive:true});


soundBtn.addEventListener('click', ()=>{
  audioOn=!audioOn;
  soundLbl.textContent=audioOn?"éŸ³æ•ˆï¼šé–‹":"éŸ³æ•ˆï¼šé—œ";
  soundBtn.querySelector('.iconDot').style.opacity=audioOn?"1":".35";
  if(audioOn) beep('good');
});

startBtn.addEventListener('click',()=>startGame());
retryBtn.addEventListener('click',()=>startGame());
howBtn.addEventListener('click',()=>howOverlay.classList.remove('hide'));
closeHow.addEventListener('click',()=>howOverlay.classList.add('hide'));
closeHow2.addEventListener('click',()=>howOverlay.classList.add('hide'));

shareBtn.addEventListener('click',async ()=>{
  const msg=buildShareText();
  await copyText(msg);
  showToast("å·²è¤‡è£½ï¼Œå¯è²¼åˆ° LINE ç¾¤",'good');
});
shareCardBtn.addEventListener('click', async ()=>{
  const url = renderShareCardPNG();
  const a = document.createElement('a');
  a.href = url;
  a.download = "hongbao_dash_score.png";
  a.click();
  URL.revokeObjectURL(url);
  showToast("å·²ä¸‹è¼‰æˆç¸¾å¡ PNG",'good');
});

async function copyText(msg){
  try{
    await navigator.clipboard.writeText(msg);
  }catch(e){
    const ta=document.createElement('textarea');
    ta.value=msg; ta.style.position='fixed'; ta.style.left='-9999px';
    document.body.appendChild(ta); ta.select();
    try{ document.execCommand('copy'); } catch(err){ alert(msg); }
    document.body.removeChild(ta);
  }
}
function buildShareText(){
  const title=`æˆ‘åœ¨ã€Š${CONFIG.gameTitle}ã€‹æ¶åˆ° ${fmtInt(score)} åˆ†ï¼`;
  const n = sanitizeText(nameInput?.value);
  const m = sanitizeText(msgInput?.value);
  const detail=`${n?('ç©å®¶ '+n+'ï½œ'):''}Perfect ${perfectHits} æ¬¡ï½œåŠ åˆ† ${goodHits}ï½œæ‰£åˆ† ${badHits}ï½œæœ€é«˜å€ç‡ x${maxMult}${m?('ï½œ'+m):''}`;
  const wish=`${CONFIG.companyName}ï½œ${CONFIG.blessing}`;
  const link=(location.href && location.href.startsWith('http')) ? `\nä¸€èµ·ç©ï¼š${location.href}` : "";
  return `${title}\n${detail}\n${wish}${link}`;
}

/* =========================
   Flow
========================= */
function startGame(){
  state=STATE.PLAY;
  startOverlay.classList.add('hide');
  endOverlay.classList.add('hide');
  howOverlay.classList.add('hide');

  score=0;
  comboGoodTotal=0; maxMult=1;
  goodHits=0; badHits=0;
  perfectHits=0; okHits=0; missHits=0;
  emptyStreak=0; lastEmptyAt=-999;

  entities=[]; sparks=[]; popups=[];
  screenShake=0;

  tStart=now();
  tLeft=CONFIG.durationSec;
  scheduleSpawn(0);
  updateComboUI();
}
function endGame(){
  state=STATE.END;

  best=Math.max(best, Math.round(score));
  localStorage.setItem(LS_KEY,String(best));

  finalScore.textContent=fmtInt(score);
  finalMult.textContent="x"+maxMult;
  finalPerfect.textContent=`${perfectHits}`;
  bestScoreEl.textContent=fmtInt(best);

  endOverlay.classList.remove('hide');
  // Phase 2 reset
  submitted=false;
  if(nameInput) nameInput.value='';
  if(msgInput) msgInput.value='';
  if(submitBtn) submitBtn.disabled=true;
  setSubmitState('', 'å°šæœªé€å‡º');
  bindPhase2Refs();
}

/* =========================
   Render
========================= */
function drawBackground(t){
  const g=ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,"#2a0f0f");
  g.addColorStop(0.55,"#120909");
  g.addColorStop(1,"#070404");
  ctx.fillStyle=g; ctx.fillRect(0,0,W,H);

  // street block
  ctx.save();
  ctx.globalAlpha=0.70;
  ctx.fillStyle="rgba(0,0,0,.56)";
  ctx.fillRect(0,H*0.62,W,H*0.38);
  ctx.restore();

  // lanterns
  for(const L of lanterns){
    const sway=Math.sin(t*L.speed+L.phase)*L.sway*dpr*L.depth;
    const x=L.x+sway;
    const y2=L.y+Math.cos(t*L.speed*0.9+L.phase)*2*dpr*L.depth;

    ctx.strokeStyle="rgba(255,255,255,.12)";
    ctx.lineWidth=2*dpr*L.depth;
    ctx.beginPath(); ctx.moveTo(x,y2-20*dpr*L.depth); ctx.lineTo(x,y2-L.r); ctx.stroke();

    const rg=ctx.createRadialGradient(x,y2,L.r*0.4,x,y2,L.r*2.6);
    rg.addColorStop(0,`rgba(247,211,122,${0.20+L.glow*0.28})`);
    rg.addColorStop(1,"rgba(247,211,122,0)");
    ctx.fillStyle=rg;
    ctx.beginPath(); ctx.arc(x,y2,L.r*2.6,0,Math.PI*2); ctx.fill();

    ctx.fillStyle="rgba(255,77,77,.90)";
    ctx.beginPath(); ctx.ellipse(x,y2,L.r*0.9,L.r*1.18,0,0,Math.PI*2); ctx.fill();
  }
}

function drawEntity(e, t){
  const age = t - e.t;
  const lifeLeft = Math.max(0, e.ttl - age);

  // appear / disappear
  const appear = clamp(age/0.12, 0, 1);
  const vanish = clamp(lifeLeft/0.18, 0, 1);
  const vis = appear * vanish;

  // float
  const bob = Math.sin(age*6 + e.x*0.001)*3*dpr;
  const x = e.x;
  const y = e.y + bob;

  const isBad = (e.type==='nian' || e.type==='bomb');
  const isSuper = (e.type==='super_hongbao');

  // glow
  const glowR = e.r*(isSuper?2.3:1.9);
  const glow = ctx.createRadialGradient(x,y, e.r*0.2, x,y, glowR);
  glow.addColorStop(0, isSuper ? `rgba(255,255,255,${0.18*vis})` :
                    isBad ? `rgba(255,77,77,${0.22*vis})` : `rgba(247,211,122,${0.22*vis})`);
  glow.addColorStop(1, "rgba(0,0,0,0)");
  ctx.fillStyle = glow;
  ctx.beginPath(); ctx.arc(x,y,glowR,0,Math.PI*2); ctx.fill();

  ctx.save();
  ctx.globalAlpha = vis;
  ctx.translate(x,y);
  ctx.rotate(e.rot);

  // ring hint
  ctx.save();
  ctx.globalAlpha = isSuper ? 0.34 : 0.18;
  ctx.strokeStyle = isSuper ? "rgba(255,255,255,.95)" : isBad ? "rgba(255,77,77,.9)" : "rgba(247,211,122,.9)";
  ctx.lineWidth = (isSuper?3:2)*dpr;
  ctx.beginPath(); ctx.arc(0,0,e.r,0,Math.PI*2); ctx.stroke();
  ctx.restore();

  // helpers (uses global roundRect(ctx,...))
  function shadowOval(rx, ry, a=0.18){
    ctx.save();
    ctx.globalAlpha *= a;
    ctx.fillStyle="rgba(0,0,0,.65)";
    ctx.beginPath(); ctx.ellipse(0, e.r*0.72, rx, ry, 0, 0, Math.PI*2); ctx.fill();
    ctx.restore();
  }
  function sparkle(){
    ctx.save();
    ctx.globalAlpha*=0.9;
    ctx.fillStyle="rgba(255,255,255,.95)";
    ctx.font = `${Math.round(22*dpr)}px ui-sans-serif, system-ui`;
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText("âœ¨", -e.r*0.58, -e.r*0.75);
    ctx.fillText("âœ¨",  e.r*0.58, -e.r*0.75);
    ctx.restore();
  }

  // ----- draw per type -----
  if(e.type==='nian'){
    // existing Q nian face (kept)
    const r = e.r;
    shadowOval(r*0.60, r*0.28, 0.22);

    const bodyGrad = ctx.createRadialGradient(-r*0.25,-r*0.35,r*0.2,0,0,r*1.2);
    bodyGrad.addColorStop(0,'rgba(255,140,140,.98)');
    bodyGrad.addColorStop(1,'rgba(170,35,35,.98)');
    ctx.fillStyle = bodyGrad;
    ctx.beginPath(); ctx.arc(0,0,r*0.95,0,Math.PI*2); ctx.fill();

    ctx.fillStyle='rgba(255,225,165,.98)';
    ctx.beginPath();
    ctx.moveTo(-r*0.55,-r*0.65); ctx.quadraticCurveTo(-r*0.85,-r*0.95,-r*0.65,-r*0.25);
    ctx.quadraticCurveTo(-r*0.40,-r*0.45,-r*0.55,-r*0.65); ctx.fill();
    ctx.beginPath();
    ctx.moveTo(r*0.55,-r*0.65); ctx.quadraticCurveTo(r*0.85,-r*0.95,r*0.65,-r*0.25);
    ctx.quadraticCurveTo(r*0.40,-r*0.45,r*0.55,-r*0.65); ctx.fill();

    ctx.fillStyle='rgba(0,0,0,.88)';
    ctx.beginPath(); ctx.ellipse(-r*0.26,-r*0.12,r*0.16,r*0.18,0,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(r*0.26,-r*0.12,r*0.16,r*0.18,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='rgba(255,255,255,.95)';
    ctx.beginPath(); ctx.arc(-r*0.21,-r*0.18,r*0.05,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(r*0.21,-r*0.18,r*0.05,0,Math.PI*2); ctx.fill();

    ctx.strokeStyle='rgba(0,0,0,.60)';
    ctx.lineWidth=6*dpr;
    ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(-r*0.44,-r*0.34); ctx.lineTo(-r*0.10,-r*0.26); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(r*0.44,-r*0.34); ctx.lineTo(r*0.10,-r*0.26); ctx.stroke();

    ctx.fillStyle='rgba(30,0,0,.72)';
    ctx.beginPath(); ctx.ellipse(0,r*0.25,r*0.34,r*0.22,0,0,Math.PI*2); ctx.fill();

    ctx.fillStyle='rgba(255,255,255,.96)';
    ctx.beginPath(); ctx.moveTo(-r*0.14,r*0.16); ctx.lineTo(-r*0.06,r*0.32); ctx.lineTo(-r*0.22,r*0.30); ctx.closePath(); ctx.fill();
    ctx.beginPath(); ctx.moveTo(r*0.14,r*0.16); ctx.lineTo(r*0.06,r*0.32); ctx.lineTo(r*0.22,r*0.30); ctx.closePath(); ctx.fill();

    ctx.fillStyle='rgba(255,205,205,.28)';
    ctx.beginPath(); ctx.arc(-r*0.45,r*0.05,r*0.18,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(r*0.45,r*0.05,r*0.18,0,Math.PI*2); ctx.fill();
  }
  else if(e.type==='hongbao' || e.type==='super_hongbao'){
    // Red packet: add flap line + knot/tassel + "ç¦å°" stamp
    const r=e.r;
    const superPack = (e.type==='super_hongbao');
    shadowOval(r*0.62, r*0.26, 0.18);

    // body
    const g1=ctx.createLinearGradient(0,-r,0,r);
    if(superPack){
      g1.addColorStop(0,'rgba(255,155,155,.98)');
      g1.addColorStop(1,'rgba(205,20,20,.98)');
    }else{
      g1.addColorStop(0,'rgba(255,120,120,.98)');
      g1.addColorStop(1,'rgba(200,28,28,.98)');
    }
    ctx.fillStyle=g1;
    roundRect(ctx, -r*0.66, -r*0.78, r*1.32, r*1.58, r*0.28);
    ctx.fill();

    // banknote peek
    ctx.save();
    ctx.globalAlpha*=0.9;
    ctx.fillStyle='rgba(210,245,220,.95)';
    roundRect(ctx, -r*0.46, -r*0.86, r*0.92, r*0.36, r*0.10);
    ctx.fill();
    ctx.strokeStyle='rgba(80,140,90,.35)';
    ctx.lineWidth=2*dpr;
    ctx.stroke();
    ctx.restore();

// border
    ctx.lineWidth=(superPack?5:4)*dpr;
    ctx.strokeStyle= superPack ? 'rgba(255,255,255,.50)' : 'rgba(255,220,160,.55)';
    ctx.stroke();

    // flap line (the key that makes it look like a red packet, not a card)
    ctx.save();
    ctx.globalAlpha*=0.55;
    ctx.strokeStyle='rgba(255,255,255,.25)';
    ctx.lineWidth=3*dpr;
    ctx.lineCap='round';
    ctx.beginPath();
    ctx.moveTo(-r*0.54, -r*0.38);
    ctx.quadraticCurveTo(0, -r*0.48, r*0.54, -r*0.38);
    ctx.stroke();
    ctx.restore();

    // golden seal ring + inner "ç¦å°"(square stamp feel)
    const sealR = superPack ? r*0.36 : r*0.30;
    const g2=ctx.createRadialGradient(-sealR*0.35,-sealR*0.35,sealR*0.15,0,0,sealR*1.25);
    g2.addColorStop(0, superPack?'rgba(255,255,255,.98)':'rgba(255,240,200,.98)');
    g2.addColorStop(1,'rgba(247,211,122,.98)');
    ctx.fillStyle=g2;
    ctx.beginPath(); ctx.arc(0,0,sealR,0,Math.PI*2); ctx.fill();

    ctx.save();
    ctx.globalAlpha*=0.9;
    ctx.strokeStyle='rgba(160,95,20,.45)';
    ctx.lineWidth=3*dpr;
    ctx.beginPath(); ctx.arc(0,0,sealR*0.82,0,Math.PI*2); ctx.stroke();

    // inner square stamp (no text, but looks like a stamp)
    ctx.fillStyle='rgba(170,85,15,.55)';
    roundRect(ctx, -sealR*0.40, -sealR*0.40, sealR*0.80, sealR*0.80, sealR*0.10);
    ctx.fill();
    ctx.restore();

    // knot + tassel (another key)
    ctx.save();
    const kx=0, ky=r*0.54;
    ctx.translate(kx,ky);
    ctx.globalAlpha*=0.95;

    // knot
    ctx.fillStyle='rgba(247,211,122,.98)';
    ctx.beginPath(); ctx.arc(0,0,r*0.12,0,Math.PI*2); ctx.fill();

    // ribbon sides
    ctx.globalAlpha*=0.9;
    ctx.fillStyle='rgba(255,225,165,.98)';
    ctx.beginPath();
    ctx.moveTo(-r*0.10, -r*0.02);
    ctx.quadraticCurveTo(-r*0.36, r*0.08, -r*0.24, r*0.22);
    ctx.quadraticCurveTo(-r*0.06, r*0.14, -r*0.10, -r*0.02);
    ctx.fill();
    ctx.beginPath();
    ctx.moveTo(r*0.10, -r*0.02);
    ctx.quadraticCurveTo(r*0.36, r*0.08, r*0.24, r*0.22);
    ctx.quadraticCurveTo(r*0.06, r*0.14, r*0.10, -r*0.02);
    ctx.fill();

    // tassel string
    ctx.strokeStyle='rgba(255,225,165,.85)';
    ctx.lineWidth=4*dpr;
    ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(0,r*0.10); ctx.lineTo(0,r*0.40); ctx.stroke();

    // tassel beads
    ctx.fillStyle='rgba(247,211,122,.98)';

    for(let i=0;i<3;i++){
      ctx.beginPath(); ctx.arc(0, r*0.46 + i*r*0.11, r*0.06, 0, Math.PI*2); ctx.fill();
    }
    ctx.restore();

    if(superPack){
      sparkle();
      ctx.save();
      ctx.globalAlpha*=0.55;
      ctx.strokeStyle="rgba(255,255,255,.85)";
      ctx.lineWidth=4*dpr;
      ctx.beginPath(); ctx.arc(0,0,r*0.96, -0.25*Math.PI, 0.85*Math.PI); ctx.stroke();
      ctx.restore();
    }
  }
  else if(e.type==='yuanbao'){
    // Yuanbao side view (clearer than top view)
    const r=e.r;
    shadowOval(r*0.70, r*0.30, 0.18);

    // base body (side)
    const g1=ctx.createLinearGradient(-r,0,r,0);
    g1.addColorStop(0,'rgba(255,245,210,.98)');
    g1.addColorStop(0.5,'rgba(245,175,70,.98)');
    g1.addColorStop(1,'rgba(215,135,30,.98)');
    ctx.fillStyle=g1;
    ctx.beginPath();
    roundRect(ctx, -r*0.78,-r*0.36,r*1.56,r*0.72,r*0.30);
    ctx.fill();

    // rim
    ctx.strokeStyle='rgba(255,220,160,.55)';
    ctx.lineWidth=4*dpr;
    ctx.stroke();

    // engraved groove
    ctx.save();
    ctx.globalAlpha*=0.45;
    ctx.strokeStyle='rgba(140,85,25,.55)';
    ctx.lineWidth=3*dpr;
    ctx.beginPath();
    ctx.moveTo(-r*0.52,0);
    ctx.quadraticCurveTo(0,r*0.10,r*0.52,0);
    ctx.stroke();
    ctx.restore();

    // shine
    ctx.save();
    ctx.globalAlpha*=0.55;
    ctx.fillStyle='rgba(255,255,255,.65)';
    ctx.beginPath();
    ctx.ellipse(-r*0.40,-r*0.12,r*0.22,r*0.10,-0.4,0,Math.PI*2);
    ctx.fill();
    ctx.restore();
  }
  else if(e.type==='lantern'){
    const r=e.r;
    shadowOval(r*0.62, r*0.26, 0.16);

    const g1=ctx.createLinearGradient(0,-r,0,r);
    g1.addColorStop(0,'rgba(255,120,120,.98)');
    g1.addColorStop(1,'rgba(200,30,30,.98)');
    ctx.fillStyle=g1;
    ctx.beginPath();
    ctx.ellipse(0,0,r*0.62,r*0.78,0,0,Math.PI*2);
    ctx.fill();

    ctx.save();
    ctx.globalAlpha*=0.35;
    ctx.strokeStyle='rgba(255,220,160,.55)';
    ctx.lineWidth=4*dpr;
    for(let i=-2;i<=2;i++){
      ctx.beginPath();
      ctx.ellipse(i*r*0.12,0,r*0.52,r*0.70,0,0,Math.PI*2);
      ctx.stroke();
    }
    ctx.restore();

    ctx.fillStyle='rgba(247,211,122,.95)';
    roundRect(ctx, -r*0.40, -r*0.92, r*0.80, r*0.22, r*0.10); ctx.fill();
    roundRect(ctx, -r*0.36, r*0.72, r*0.72, r*0.18, r*0.10); ctx.fill();

    ctx.save();
    ctx.translate(0, r*0.98);
    ctx.fillStyle='rgba(247,211,122,.95)';
    for(let k=-1;k<=1;k++){
      ctx.beginPath(); ctx.arc(k*r*0.16, k==0?0:r*0.10, r*0.10, 0, Math.PI*2); ctx.fill();
    }
    ctx.restore();
  }
    else if(e.type==='bomb'){
    const r=e.r;
    shadowOval(r*0.70, r*0.30, 0.20);

    const g1=ctx.createRadialGradient(-r*0.22,-r*0.28,r*0.15,0,0,r*1.0);
    g1.addColorStop(0,'rgba(90,90,95,.98)');
    g1.addColorStop(1,'rgba(20,20,25,.98)');
    ctx.fillStyle=g1;
    ctx.beginPath(); ctx.arc(0,0,r*0.76,0,Math.PI*2); ctx.fill();

    ctx.save();
    ctx.globalAlpha*=0.55;
    ctx.fillStyle='rgba(255,255,255,.20)';
    ctx.beginPath(); ctx.ellipse(-r*0.22,-r*0.25,r*0.22,r*0.14,-0.6,0,Math.PI*2); ctx.fill();
    ctx.restore();

    ctx.strokeStyle='rgba(255,220,160,.85)';
    ctx.lineWidth=6*dpr;
    ctx.lineCap='round';
    ctx.beginPath();
    ctx.moveTo(r*0.30,-r*0.62);
    ctx.quadraticCurveTo(r*0.65,-r*0.82,r*0.40,-r*1.00);
    ctx.stroke();

    const sp= (Math.sin(t*18)+1)/2;
    ctx.save();
    ctx.globalAlpha*= (0.45+sp*0.45);
    ctx.fillStyle='rgba(255,120,120,.95)';
    ctx.beginPath(); ctx.arc(r*0.42,-r*1.02,r*0.12,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='rgba(255,255,255,.95)';
    ctx.beginPath(); ctx.arc(r*0.46,-r*1.06,r*0.06,0,Math.PI*2); ctx.fill();
    ctx.restore();

    // cute "evil" eyes
    ctx.save();
    ctx.globalAlpha*=0.25;
    ctx.fillStyle='rgba(255,255,255,.55)';
    ctx.beginPath(); ctx.arc(-r*0.18,-r*0.08,r*0.08,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(r*0.18,-r*0.08,r*0.08,0,Math.PI*2); ctx.fill();
    ctx.restore();
  }
  else {
    // fallback
    ctx.textAlign='center';
    ctx.textBaseline='middle';
    ctx.font = `${Math.round(e.r*1.3)}px ui-sans-serif, system-ui`;
    ctx.fillStyle="rgba(255,255,255,.9)";
    ctx.fillText("ğŸ§§",0,0);
  }

  ctx.restore();
}

function drawSparks(t){
  const g = 980 * dpr;
  for(const s of sparks){
    const age = t - s.t;
    const a = clamp(1 - age/s.life, 0, 1);
    if(a<=0) continue;
    const tt = age;
    const x = s.x + s.vx*tt*0.001;
    const y = s.y + s.vy*tt*0.001 + 0.5*g*(tt*tt)*0.000001;

    ctx.save();
    ctx.globalAlpha = a;
    ctx.fillStyle = s.kind==='bad' ? 'rgba(255,77,77,1)' :
                    s.kind==='super' ? 'rgba(255,255,255,1)' :
                    'rgba(247,211,122,1)';
    ctx.beginPath();
    ctx.arc(x,y, (s.kind==='super'?2.6:2.0)*dpr, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();
  }
  sparks = sparks.filter(s => (t - s.t) < s.life);
}

function drawPopups(t){
  for(const p of popups){
    const age=t-p.t;
    const a=clamp(1-age/p.life,0,1);
    const y=p.y - age*68*dpr;
    const bump = Math.sin(age*10)*2*dpr*(p.kind==='perfect'?1.0:0.6);

    ctx.save();
    ctx.globalAlpha=a;

    ctx.textAlign='center';
    ctx.textBaseline='middle';

    let fontSize = 20*dpr;
    let weight = 800;
    if(p.kind==='perfect') { fontSize = 30*dpr; weight = 950; }
    if(p.kind==='super')   { fontSize = 32*dpr; weight = 950; }
    if(p.kind==='bad')     { fontSize = 22*dpr; weight = 900; }

    ctx.font=`${weight} ${Math.round(fontSize)}px ui-sans-serif, system-ui`;

    const color = p.kind==='super' ? 'rgba(255,255,255,1)' :
                  p.kind==='perfect' ? 'rgba(255,220,160,1)' :
                  p.kind==='good' ? 'rgba(247,211,122,1)' :
                  p.kind==='bad' ? 'rgba(255,77,77,1)' :
                  'rgba(200,200,200,1)';

    // shadow/outline layer
    ctx.lineWidth = (p.kind==='perfect' || p.kind==='super') ? 6*dpr : 4*dpr;
    ctx.strokeStyle = 'rgba(0,0,0,.55)';
    ctx.strokeText(p.text, p.x, y + bump);

    // glow
    if(p.kind==='perfect' || p.kind==='super'){
      ctx.shadowBlur = 18*dpr;
      ctx.shadowColor = p.kind==='super' ? 'rgba(255,255,255,.55)' : 'rgba(247,211,122,.45)';
    }

    ctx.fillStyle=color;
    ctx.fillText(p.text,p.x,y + bump);
    ctx.restore();
  }
  popups=popups.filter(p => (t-p.t) < p.life);
}

/* =========================
   Loop
========================= */
let lastT=now();
function tick(){
  const t=now();
  const dt=Math.min(0.033,t-lastT);
  lastT=t;

  if(state===STATE.PLAY){
    const elapsed=t-tStart;
    tLeft=Math.max(0, CONFIG.durationSec - elapsed);

    // spawn
    if(t>=nextSpawnAt && entities.length < maxAlive(elapsed)){
      spawnEntity(elapsed);
      scheduleSpawn(elapsed);
    }

    // update entities
    for(const e of entities){
      e.x += e.vx*dt;
      e.y += e.vy*dt;

      // bounce walls gently
      if(e.x < 60*dpr || e.x > W-60*dpr) e.vx *= -1;
      if(e.y < 120*dpr || e.y > H-140*dpr) e.vy *= -1;
    }

    // expire
    const tt = now();
    entities = entities.filter(e => (tt - e.t) < e.ttl);

    if(tLeft<=0) endGame();
  }

  screenShake=Math.max(0, screenShake - dt*18);

  // render
  ctx.save();
  if(screenShake>0){
    const s=screenShake*dpr;
    ctx.translate(rand(-s,s), rand(-s,s));
  }
  drawBackground(t);
  for(const e of entities) drawEntity(e,t);
  drawSparks(t);
  drawPopups(t);
  ctx.restore();

  if(state===STATE.PLAY){
    timeV.textContent=fmt1(tLeft);
    scoreV.textContent=fmtInt(score);
    comboV.textContent="x"+multiplier();
    hint.style.opacity = (t - tStart < 7) ? "1" : "0";
  }

  requestAnimationFrame(tick);
}
requestAnimationFrame(tick);

/* =========================
   Share Card (PNG)
========================= */

function badgePill(g,x,y,text){
  roundRect(g,x,y, 520, 56, 22);
  g.fillStyle='rgba(0,0,0,.30)'; g.fill();
  g.lineWidth=2; g.strokeStyle='rgba(255,255,255,.14)'; g.stroke();
  g.fillStyle='rgba(255,255,255,.88)';
  g.font='800 28px ui-sans-serif, system-ui';
  g.fillText(text, x+18, y+38);
}

function renderShareCardPNG(){
  const w = 1080, h = 1350;
  const c = document.createElement('canvas');
  c.width = w; c.height = h;
  const g = c.getContext('2d');

  // Background
  const bg = g.createRadialGradient(w*0.5,h*0.18,0,w*0.5,h*0.18,w*0.95);
  bg.addColorStop(0,'#4a1717');
  bg.addColorStop(0.55,'#140909');
  bg.addColorStop(1,'#070404');
  g.fillStyle = bg; g.fillRect(0,0,w,h);

  // Confetti
  for(let i=0;i<130;i++){
    const x= Math.random()*w, y=Math.random()*h*0.75;
    const r= 2+Math.random()*5;
    const a= Math.random()*Math.PI*2;
    g.save();
    g.translate(x,y);
    g.rotate(a);
    g.globalAlpha=0.18+Math.random()*0.20;
    g.fillStyle = (Math.random()<0.5) ? '#f7d37a' : '#ff6b6b';
    g.fillRect(-r*2,-r,r*4,r*2.2);
    g.restore();
  }

  // Header
  g.fillStyle = 'rgba(255,255,255,.95)';
  g.font = '950 70px ui-sans-serif, system-ui';
  g.fillText('æ¶ç´…åŒ…å¿«é–ƒ', 84, 150);
  g.fillStyle = 'rgba(255,255,255,.75)';
  g.font = '700 32px ui-sans-serif, system-ui';
  g.fillText('æ–°å¹´äº’å‹•è³€å¡ï½œ60 ç§’è¡æ¦œ', 84, 205);

  // Social sticker
  roundRect(g, w-330, 110, 246, 72, 26);
  g.fillStyle='rgba(0,0,0,.38)'; g.fill();
  g.lineWidth=3; g.strokeStyle='rgba(255,255,255,.14)'; g.stroke();
  g.fillStyle='rgba(255,255,255,.85)';
  g.font='800 28px ui-sans-serif, system-ui';
  g.fillText('è²¼åˆ°LINEç¾¤', w-310, 156);

  // Score panel
  const px=84, py=250, pw=w-168, ph=700;
  roundRect(g, px,py,pw,ph,42);
  const pg = g.createLinearGradient(0,py,0,py+ph);
  pg.addColorStop(0,'rgba(255,255,255,.10)');
  pg.addColorStop(1,'rgba(0,0,0,.40)');
  g.fillStyle=pg; g.fill();
  g.lineWidth=3; g.strokeStyle='rgba(255,255,255,.16)'; g.stroke();

  g.fillStyle='rgba(255,255,255,.65)';
  g.font='800 30px ui-sans-serif, system-ui';
  g.fillText('æœ¬æ¬¡åˆ†æ•¸', px+54, py+96);

  g.fillStyle='#ffdca0';
  g.font='1000 150px ui-sans-serif, system-ui';
  g.fillText(fmtInt(score), px+54, py+260);

  // Badges
  const bx=px+54, by=py+320;
  badgePill(g, bx, by, `æœ€é«˜å€ç‡  x${maxMult}`);
  badgePill(g, bx, by+76, `Perfect ${perfectHits}ï½œMiss ${missHits}`);
  badgePill(g, bx, by+152, `åŠ åˆ† ${goodHits}  /  æ‰£åˆ† ${badHits}`);

  // CTA
  g.fillStyle='rgba(255,255,255,.70)';
  g.font='800 34px ui-sans-serif, system-ui';
  g.fillText('ä½ æ¶åˆ°å¹¾åˆ†ï¼Ÿä¾†æŒ‘æˆ°æˆ‘ï¼', px+54, py+560);
  const n = sanitizeText(nameInput?.value);
  const m = sanitizeText(msgInput?.value);
  if(n){ g.font = `700 ${Math.round(38*dpr)}px ui-sans-serif, system-ui`; g.fillStyle='rgba(255,255,255,.92)'; g.fillText(n, px+54, py+612); }
  if(m){ g.font = `${Math.round(28*dpr)}px ui-sans-serif, system-ui`; g.fillStyle='rgba(255,255,255,.72)'; g.fillText(m, px+54, py+652); }

  // Footer
  g.fillStyle='rgba(255,255,255,.92)';
  g.font='900 44px ui-sans-serif, system-ui';
  g.fillText(CONFIG.companyName, 84, 990);

  g.fillStyle='rgba(255,255,255,.72)';
  g.font='750 36px ui-sans-serif, system-ui';
  g.fillText(CONFIG.blessing, 84, 1052);

  g.fillStyle='rgba(255,255,255,.55)';
  g.font='650 28px ui-sans-serif, system-ui';
  g.fillText('ï¼ˆæç¤ºï¼šé»åˆ°å¹´ç¸/ç‚¸å½ˆæœƒæ‰£åˆ†ï¼Œç©ºé»å¤ªå¤šä¹Ÿæœƒæ‰£åˆ†ï¼‰', 84, 1116);

  const blob = dataURLToBlob(c.toDataURL('image/png'));
  return URL.createObjectURL(blob);
}

function roundRect(g,x,y,w,h,r){
  g.beginPath();
  g.moveTo(x+r,y);
  g.arcTo(x+w,y,x+w,y+h,r);
  g.arcTo(x+w,y+h,x,y+h,r);
  g.arcTo(x,y+h,x,y,r);
  g.arcTo(x,y,x+w,y,r);
  g.closePath();
}

function dataURLToBlob(dataURL){
  const [head,body]=dataURL.split(',');
  const mime=head.match(/:(.*?);/)[1];
  const bin=atob(body);
  const arr=new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i);
  return new Blob([arr],{type:mime});
}


/* =========================
   Init
========================= */
function boot(){
  timeV.textContent=fmt1(CONFIG.durationSec);
  scoreV.textContent="0";
  comboV.textContent="x1";
  soundLbl.textContent=audioOn?"éŸ³æ•ˆï¼šé–‹":"éŸ³æ•ˆï¼šé—œ";
  startOverlay.classList.remove('hide');
  endOverlay.classList.add('hide');
  updateComboUI();
}
boot();

});
</script>

<!-- Leaderboard Overlay (Top 100) -->
<div class="overlay hide" id="leaderboardOverlay" style="pointer-events:auto;">
  <div class="card big">
    <div class="lbHeader">
      <div class="lbTitle">å¼˜é¨èˆˆæ¥­æœ‰é™å…¬å¸ æ•¬è³€ï½œæ–°å¹´å¿«æ¨‚</div>
      <div class="lbSub">Top 100 æ¶ç´…åŒ…æ¦œï½œå¯«ä¸‹ç¥ç¦ï¼Œä¸€èµ·å‚³éå¥½é‹</div>
    </div>

    <div class="lbPanel">
      <div class="lbHeadRow">
        <div class="cRank">#</div>
        <div class="cName">åå­—</div>
        <div class="cScore">åˆ†æ•¸</div>
        <div class="cMsg">ç¥ç¦èª</div>
      </div>
      <div class="lbList" id="lbList"></div>
    </div>

    <div class="lbFooter">
      <div class="brandLine">Balance & Peace</div>
      <div class="lbActions">
        <button class="btn" id="lbBackBtn">è¿”å›çµç®—</button>
        <button class="btn primary" id="lbAgainBtn">å†ç©ä¸€æ¬¡</button>
      </div>
    </div>
  </div>
</div>


<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
<script>
  // Firebase init (Phase 3)
  const firebaseConfig = {
    apiKey: "AIzaSyB3nfruSXgRGrQmo9zQMAHddn7wHrQO8_w",
    authDomain: "gamecard-1aaf6.firebaseapp.com",
    projectId: "gamecard-1aaf6",
    storageBucket: "gamecard-1aaf6.firebasestorage.app",
    messagingSenderId: "934440165694",
    appId: "1:934440165694:web:63763fe51b174400280c6f",
    measurementId: "G-DV7D9TZDYP"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
</script>

</body>
</html>
